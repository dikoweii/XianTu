# 🎲 判定系统（完整标准）

⚠️ **核心理念**: 判定决定成功/失败，必须配合生动的叙事描述。

---

## 必须判定的场景

### 1. 攻击判定（根骨+灵性主导）
- 与NPC/怪物战斗
- 判定后描述: 伤害数值、敌人反应、战况变化

### 2. 防御判定（根骨+心性主导）
- 承受攻击、格挡招式、抵御法术
- 判定后描述: 受伤程度、气血损失、状态影响

### 3. 修炼判定（悟性主导）
- 突破境界、炼化天材地宝、吸收灵气、修炼功法
- 判定后描述: 属性变化、境界变化、获得的能力
- ⚡ 筑基→金丹及以上突破必须触发**渡劫系统**

### 4. 交互判定（魅力+悟性+心性主导）
- 说服/欺骗NPC、谈判交易、收服追随者、识破阴谋
- 判定后描述: NPC态度变化、好感度变化、获得/失去的东西

### 5. 探索判定（气运主导）
- 寻找宝物/秘境、破解阵法机关、触发随机事件
- 判定后描述: 获得的物品、发现的线索、遇到的危险

---

## 多因素判定公式（最新标准）

```typescript
// 步骤1：计算六司基础值
先天六司 = 基础信息.先天六司 (固定，无法改变)
后天六司 = 属性.后天六司 (修炼可提升)
最终六司 = 先天六司×100% + 后天六司×20% (后天权重低，避免过度强化)

// 步骤2：根据判定类型计算属性值
攻击判定: (根骨×3 + 灵性×4 + 灵气当前×0.5) × 境界加成
防御判定: (根骨×4 + 心性×3 + 气血上限×0.3) × 境界加成
修炼判定: (灵性×2 + 悟性×5 + 根骨×1 + 心性×1) × 境界加成
交互判定: (魅力×2 + 悟性×3 + 灵性×2 + 心性×2) × 境界加成
探索判定: (气运×3 + 灵性×3 + 悟性×2) × 境界加成

// 步骤3：境界加成（线性增长）
境界加成 = 1.0 + 境界等级×0.1
// 凡人:1.0, 练气:1.1, 筑基:1.2, 金丹:1.3, 元婴:1.4...

// 步骤4：添加其他加成
最终判定值 = 基础属性值 + 装备加成 + 功法加成 + 状态效��加成

// 步骤5：修行状态影响
// 当前气血/灵气/神识会影响判定值（已包含在步骤2的公式中）
// 资源不足时战斗力显著下降
```

---

## 关键变化

- **先天六司100%权重** + **后天六司20%权重**
- 境界加成改为线性(每级+10%)，避免高境界数值爆炸
- 修行状态(当前气血/灵气/神识)直接影响判定
- 后天六司可通过修炼、丹药、奇遇提升

---

## 计算示例（最新标准）

### 【修炼判定】筑基修士
```
- 先天六司：根骨6, 灵性7, 悟性9, 心性7, 气运8
- 后天六司：根骨+2, 灵性+3, 悟性+1 (修炼获得)
- 境界：筑基 (境界加成×1.2)
- 装备：灵识+50
- 功法：玄阶功法，熟练度30

计算最终六司：
根骨 = 6×100% + 2×20% = 6 + 0.4 = 6.4
灵性 = 7×100% + 3×20% = 7 + 0.6 = 7.6
悟性 = 9×100% + 1×20% = 9 + 0.2 = 9.2

基础属性值 = (灵性×2 + 悟性×5 + 根骨×1 + 心性×1) × 1.2
            = (7.6×2 + 9.2×5 + 6.4×1 + 7×1) × 1.2
            = (15.2 + 46 + 6.4 + 7) × 1.2
            = 74.6 × 1.2
            = 89.5

加成：
+ 装备灵识 = 50
+ 功法熟练度 = 30

最终判定值 = 89.5 + 50 + 30 = 169.5

【对比：凡人同样条件】
最终六司 = 先天(无后天)
基础值 = (7×2 + 9×5 + 6×1 + 7×1) × 1.0 = 74
加成 = 10(凡品装备) + 5(黄阶功法)
最终值 = 74 + 15 = 89
差距：筑基是凡人的 1.9倍（更合理的平衡）
```

---

## 判定结果规则（最终标准）

**判定计算公式**：
```
最终值 = 骰点(1d20) + 属性值 + 加成
```

**判定结果判定**：

| 条件 | 结果 | 效果 |
|------|------|------|
| 骰点 19-20 | **完美** | 必定成功且额外奖励（无视难度） |
| 最终值 ≥ 难度+20 | **大成功** | 显著成果，额外收益 |
| 最终值 ≥ 难度 | **成功** | 达成目标 |
| 最终值 < 难度 | **失败** | 未达成目标 |
| 骰点 1-2 | **大失败** | 必定失败且负面后果（无视属性加成） |

**⚠️ 特殊规则**：
- 骰点19-20：无论最终值多少，都判定为"完美"
- 骰点1-2：无论最终值多少，都判定为"大失败"
- 大成功需要：最终值超过难度至少20点

---

## 战斗伤害计算（新标准）

```typescript
// 命中判定
命中率 = min(95, max(5, 50 + (攻击方敏捷 - 防御方敏捷)×2))

// 暴击判定
暴击率 = 5% + 气运×2%
暴击伤害 = 基础伤害 × 2.0

// 伤害计算（注意：六司=先天×100%+后天×20%）
攻击力 = (根骨×3 + 灵性×4 + 灵气当前×0.5 + 装备 + 功法 + 状态) × 境界加成
防御力 = (根骨×4 + 心性×3 + 气血上限×0.3 + 装备 + 功法 + 状态) × 境界加成

基础伤害 = 攻击力 - 防御力×0.5
最终伤害 = 基础伤害 × (暴击?2.0:1.0) × 随机(0.9-1.1)

// 防御减免
减免% = min(75, 防御力/(防御力+100)×100)
实际伤害 = 最终伤害 × (1 - 减免%/100)
```

---

## 判定结果格式

使用标准格式：`〖判定类型:结果,骰点:数值,属性名:属性值,加成:加成值,最终值:总值,难度:难度值〗`

**字段说明**：
- `判定类型`: 修炼判定/攻击判定/防御判定/交互判定/探索判定
- `结果`: **大失败/失败/成功/大成功/完美**
- `骰点`: 1d20随机值（1-20）
- `属性名`: 主导属性及数值，如"灵性:8"、"悟性:9"
- `加成`: 装备+功法+状态等加成总和
- `最终值`: 骰点+属性+加成的总和
- `难度`: 判定难度值

**⚠️ 判定结果计算规则**：
1. **骰点19-20** → 结果必定是"完美"
2. **骰点1-2** → 结果必定是"大失败"
3. **最终值 ≥ 难度+20** → "大成功"
4. **最终值 ≥ 难度** → "成功"
5. **最终值 < 难度** → "失败"

**示例**：
- `〖修炼判定:大成功,骰点:18,灵性:8,加成:15,最终值:41,难度:20〗` (41≥20+20，大成功)
- `〖攻击判定:成功,骰点:12,根骨:7,加成:10,最终值:29,难度:20〗` (29≥20，成功)
- `〖探索判定:完美,骰点:20,气运:9,加成:5,最终值:34,难度:15〗` (骰点20，完美)
- `〖修炼判定:大失败,骰点:1,悟性:12,加成:20,最终值:33,难度:15〗` (骰点1，大失败)

---

## 核心属性数值标准 (中等资质参考)

⚠️ **使用说明**：以下数值为**中等资质修士**的参考基准，实际数值可根据**先天六司、灵根、体质、功法、奇遇**在基准上下**±30%~50%**波动。

### 气血 (HP)
| 境界 | 基准上限 | 合理范围 | 根骨影响 |
|------|----------|----------|----------|
| 凡人 | 100 | 80-150 | 每点根骨 ±10% |
| 炼气 | 300 | 200-450 | 每点根骨 ±12% |
| 筑基 | 1500 | 1000-2200 | 每点根骨 ±15% |
| 金丹 | 8000 | 5500-12000 | 每点根骨 ±18% |
| 元婴 | 50000 | 35000-75000 | 每点根骨 ±20% |
| 化神 | 300000 | 210000-450000 | 每点根骨 ±20% |
| 炼虚 | 1000000 | 700000-1500000 | 每点根骨 ±20% |
| 合体 | 2000000 | 1400000-3000000 | 每点根骨 ±20% |
| 渡劫 | 4000000 | 2800000-6000000 | 每点根骨 ±20% |

**突破境界时气血增长**: 新境界基准值 = 当前境界基准 × (2.0~3.0)

### 灵气 (MP)
| 境界 | 基准上限 | 合理范围 | 灵性影响 | 灵根影响 |
|------|----------|----------|----------|----------|
| 凡人 | 0 | 0 | - | - |
| 炼气 | 200 | 150-300 | 每点灵性 ±12% | 天灵根+100% |
| 筑基 | 1500 | 1000-2300 | 每点灵性 ±15% | 双灵根+50% |
| 金丹 | 10000 | 7000-15000 | 每点灵性 ±18% | 三灵根+25% |
| 元婴 | 70000 | 50000-110000 | 每点灵性 ±20% | 五灵根-10% |
| 化神 | 450000 | 320000-680000 | 每点灵性 ±20% | |
| 炼虚 | 2000000 | 1400000-3000000 | 每点灵性 ±20% | |
| 合体 | 4000000 | 2800000-6000000 | 每点灵性 ±20% | |
| 渡劫 | 8000000 | 5600000-12000000 | 每点灵性 ±20% | |

**突破境界时灵气增长**: 新境界基准值 = 当前境界基准 × (2.5~4.0)

### 神识 (SP)
| 境界 | 基准上限 | 合理范围 | 悟性+心性影响 | 探查范围 |
|------|----------|----------|---------------|----------|
| 凡人 | 10 | 5-20 | 每点 ±8% | 5米 |
| 炼气 | 100 | 70-150 | 每点 ±12% | 50米 |
| 筑基 | 800 | 550-1200 | 每点 ±15% | 500米 |
| 金丹 | 6000 | 4200-9000 | 每点 ±18% | 5公里 |
| 元婴 | 50000 | 35000-75000 | 每点 ±20% | 50公里 |
| 化神 | 400000 | 280000-600000 | 每点 ±20% | 500公里 |
| 炼虚 | 2000000 | 1400000-3000000 | 每点 ±20% | 3000公里 |
| 合体 | 4000000 | 2800000-6000000 | 每点 ±20% | 5000公里 |
| 渡劫 | 8000000 | 5600000-12000000 | 每点 ±20% | 8000公里 |

**突破境界时神识增长**: 新境界基准值 = 当前境界基准 × (2.5~4.0)

### 寿元 (Lifespan)
| 境界 | 基准寿命(岁) | 合理范围 | 根骨影响 |
|------|--------------|----------|----------|
| 凡人 | 100 | 60-120 | 每点根骨 +5岁 |
| 炼气 | 130 | 120-150 | 每点根骨 +3岁 |
| 筑基 | 230 | 200-270 | 每点根骨 +5岁 |
| 金丹 | 650 | 500-800 | 每点根骨 +15岁 |
| 元婴 | 1800 | 1500-2100 | 每点根骨 +30岁 |
| 化神 | 5500 | 5000-6500 | 每点根骨 +50岁 |
| 炼虚 | 12000 | 10000-15000 | 每点根骨 +100岁 |
| 合体 | 30000 | 25000-40000 | 每点根骨 +200岁 |
| 渡劫 | 50000+ | 不定 | 受天劫影响 |

**突破境界时寿命增长**: 直接跳到新境界基准寿命,当前年龄不变

### 消耗与恢复标准

**消耗比例**:
- 气血: 轻伤5-10%, 中伤15-30%, 重伤35-60%, 濒死65-90%
- 灵气: 基础法术1-3%, 中级法术5-12%, 高级法术15-35%, 法宝10-40%
- 神识: 探查0.5-2%, 鉴定1-5%, 抵抗幻术2-10%/分钟, 神识攻击15-40%

**恢复速度** (每小时):
- 气血: 0.5-2% (安全地打坐)
- 灵气: 1-5% (普通地), 10-20% (灵脉上)
- 神识: 2-8% (冥想/睡眠)

**丹药恢复**:
- 低品: 5-15%
- 中品: 20-40%
- 高品: 50-80%
- 极品: 90-100%

---

## 渡劫系统 (境界突破天劫)

### 触发规则
- ❌ **凡人→炼气**: 无需渡劫 (引气入体,判定成功即可)
- ❌ **炼气内部突破**: 无需渡劫 (初期→中期→后期→圆满→极境)
- 🔶 **炼气→筑基**: 可选渡劫 (直接突破/引天劫突破,后者成功后根基更深厚)
- ⚡ **筑基→金丹及以上**: 必须渡劫!

### 天劫难度 (劫雷道数)
| 境界突破 | 劫雷道数 | 基础判定难度 | 死亡率 | 劫名 |
|----------|----------|--------------|--------|------|
| 筑基→金丹 | 3道 | 30 | 20% | 凝丹劫 |
| 金丹→元婴 | 6道 | 35 | 30% | 碎丹劫 |
| 元婴→化神 | 9道 | 40 | 50% | 化神劫 |
| 化神→炼虚 | 12道 | 45 | 70% | 炼虚劫 |
| 炼虚→合体 | 18道 | 50 | 80% | 合体劫 |
| 合体→渡劫 | 27道 | 55 | 85% | 问心劫 |

**每道劫雷难度递增**: 基础难度 + (劫雷序号-1) × 3

### 难度修正因素
**增加难度** (劫雷威力+20%~100%): 魔功/杀孽过重/逆天改命/身怀至宝
**降低难度** (劫雷威力-10%~30%): 功德深厚/天资卓越/圣地渡劫/渡劫至宝

### 渡劫流程
1. **突破征兆**: 修为圆满→给予准备选择
2. **天劫降临**: 劫云汇聚→NPC反应→第一道劫雷
3. **劫雷判定**: 每1~2道判定一次,失败受重伤
4. **结果结算**: 成功突破/失败死亡

### 渡劫判定规则
**判定公式**: 防御判定 = (根骨×4 + 心性×3 + 气血上限×0.3) × 境界加成

**判定结果**:
- 完美(骰点19-20): 伤害-50%, 额外奖励
- 成功: 正常承受伤害
- 失败: 伤害×1.5
- 大失败(骰点1-2): 伤害×2.0, 可能死亡

### 渡劫奖励
**成功**: 境界突破/属性暴涨/寿命跳跃/称号声望/先天六司+1
**完美**: 直接突破到中期/属性+50%/天道认可/额外奖励翻倍
**失败**: 肉身毁灭/元婴遁走/境界跌落/寿命-100~300岁

### 特殊事件
**心魔劫** (化神劫及以上): 需通过交互判定
**被偷袭**: 仇家趁机偷袭
**天道奖励**: 完美渡劫获天道认可

###叙事要点
- 分段描写,每1~2道劫雷暂停,等待玩家互动
- 关键时刻给予玩家选择(服用丹药/燃烧精血/呼救护法)
- 渲染环境和NPC反应(劫云/雷鸣/山崩/惊骇)
