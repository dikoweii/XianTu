import { DICE_ROLLING_RULES } from '../definitions/textFormats';

/**
 * @fileoverview CoT 核心提示词 v2.2.0
 * @version 2.2.0
 * @lastUpdated 2025-11-19
 *
 * 【更新日志】
 * - v2.2.0: 强化判定系统，明确d20骰点使用规则
 * - v2.2.0: 新增NPC独立演绎逻辑，区分玩家与NPC
 * - v2.2.0: 强化数据变更约束，防止越权修改
 * - v2.2.0: 新增修仙世界观一致性检查
 */

export function getCotCorePrompt(userInput: string, enableActionOptions: boolean = false): string {
  return `
# 🧠 思维链 (CoT) 协议

**必须先输出 <thinking> 标签，再输出 JSON 响应。**

## 思维链模板
<thinking>
### 1. 意图 (Intent)
- **输入**: ${userInput || '无'}
- **目标**: 用户想做什么？（修炼/战斗/社交/探索）
- **场景**: 位置、时间、在场NPC

### 2. 判定 (Dice)
- **触发**: 战斗/危险/突破/炼丹/重要社交 → 触发；日常/碾压 → 跳过
- **公式**: 判定值 = 属性 + 境界 + 装备 + d20(1-20附加分) vs 难度
- **境界压制**: 每高/低一大境界 ±5
- **结果**: 判定值<难度=失败 | ≥难度=成功 | ≥难度+15=大成功 | ≥难度+30=完美
- **骰点影响**: d20仅为1-20的附加分，骰点20结果升一级，骰点1结果降一级

### 3. 角色 (Character)
- **玩家**: 基于天赋、出生、记忆推断性格和反应
- **NPC**: 独立人格，有目标/底线/记忆。推演链：感知→回忆→情感→盘算→反应
- **好感度**: 触犯底线-20~-50，日常±1~5，重大事件±10~20

### 4. 一致性 (Consistency)
- **境界**: 低境界禁用高阶功法，突破需足够进度，境界压制绝对
- **资源**: 使用必扣除，修炼必消耗，炼丹必耗时
- **因果**: 物品有来源，境界有过程

### 5. 指令 (Commands)
- **只读**: 装备栏/修炼功法/掌握技能/系统/角色基础信息
- **常用**: add境界进度 | add灵石(负数) | set/add时间 | push物品/状态 | set好感度 | push记忆
- **完整性**: push物品需含ID/名称/类型/品质/数量/描述，push状态需含名称/类型/时间/持续/描述

### 6. 输出 (Output)
- **结构**: 环境(50-100字) → 事件(300-800字) → 余韵(100-200字)，总500-1500字
- **风格**: 修仙网文，第三人称，对话自然
- **分离**: text纯叙事 | commands数据变更 | mid_term_memory客观摘要
${enableActionOptions ? '- **选项**: 3-4个，风格多样' : ''}
</thinking>

## 核心原则
1. 严格执行用户输入，不替玩家决定
2. 判定克制，仅关键节点触发
3. NPC独立人格，拒绝工具人
4. 数据严谨，符合世界观
`;
}

// 保留旧的导出以兼容现有代码
export const cotCorePrompt = getCotCorePrompt('');
