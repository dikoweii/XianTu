/**
 * @fileoverview 增强游戏提示词系统
 * 基于初始化提示词优化的修仙战斗提示词，包含预计算值和强制酒馆数据传输
 */

import { generateSystemPrompt } from './systemPrompts';
import { CHARACTER_INITIALIZATION_PROMPT } from './characterInitializationPrompts';

// 修仙境界计算系统
export const CULTIVATION_CALCULATION_SYSTEM = `
## 修仙境界计算系统

### 境界数值对照表（预计算值）：
- 凡人(0): 气血100, 灵气0, 神识10, 寿命80年, 修为上限0
- 炼气(1): 气血120-200, 灵气50-150, 神识15-30, 寿命100年, 修为上限500
- 筑基(2): 气血200-350, 灵气150-300, 神识30-60, 寿命150年, 修为上限1500
- 金丹(3): 气血350-600, 灵气300-600, 神识60-120, 寿命300年, 修为上限5000
- 元婴(4): 气血600-1000, 灵气600-1200, 神识120-250, 寿命500年, 修为上限15000
- 化神(5): 气血1000-1800, 灵气1200-2500, 神识250-500, 寿命800年, 修为上限50000
- 炼虚(6): 气血1800-3000, 灵气2500-5000, 神识500-1000, 寿命1200年, 修为上限150000
- 合体(7): 气血3000-5000, 灵气5000-10000, 神识1000-2000, 寿命2000年, 修为上限500000
- 渡劫(8): 气血5000+, 灵气10000+, 神识2000+, 寿命3000年+, 修为上限1000000+

### 突破计算公式：
- 突破成功率 = (当前修为/所需修为) × (悟性/10) × (功法品质系数) × (天赋加成) × (状态效果影响)
- 功法品质系数: 凡级1.0, 黄级1.2, 玄级1.5, 地级2.0, 天级3.0, 仙级5.0, 神级10.0
- 失败惩罚: 修为损失10-30%, 可能产生心魔状态效果

### 战斗力评估公式：
战斗力 = (气血 × 0.3) + (灵气 × 0.4) + (神识 × 0.2) + (境界等级 × 100) + (装备加成) + (功法加成) + (状态效果加成)
`;

// 战斗系统计算
export const COMBAT_CALCULATION_SYSTEM = `
## 战斗系统计算

### 伤害计算公式：
- 物理伤害 = (攻击者气血/10 + 装备攻击力) × 技能倍率 × (1 - 防御者气血/防御者气血+攻击者气血/2)
- 法术伤害 = (攻击者灵气/5 + 法宝威力) × 法术倍率 × (1 - 防御者神识/防御者神识+攻击者神识/3)
- 暴击率 = (魅力/100) + 装备暴击率加成
- 暴击伤害 = 基础伤害 × (1.5 + 暴击伤害加成)

### 技能消耗计算：
- 基础技能: 消耗灵气 = 技能等级 × 10
- 高级技能: 消耗灵气 = 技能等级 × 25 + 额外消耗
- 绝技: 消耗灵气 = 当前灵气的30-50%

### 境界压制效果：
- 高一个大境界: 全属性+20%, 技能威力+30%
- 高两个大境界: 全属性+50%, 技能威力+70%, 有几率直接震慑敌人
- 高三个大境界以上: 碾压级优势，低境界者难以造成有效伤害

### 状态效果战斗影响：
- 受伤状态: 气血<50%时，所有能力-15%; <25%时，所有能力-30%
- 灵气枯竭: 灵气<20%时，法术威力-50%; <10%时，无法使用高级技能
- 心魔状态: 随机失控，可能攻击友方或自己
- 狂暴状态: 攻击力+50%，防御力-30%，无法使用精细技能
`;

// 丹药炼制系统
export const ALCHEMY_CALCULATION_SYSTEM = `
## 丹药炼制计算系统

### 炼丹成功率计算：
成功率 = (炼丹技能/100) × (悟性/10) × (灵性/10) × (丹炉品质系数) × (材料品质系数) - (丹药难度系数)

### 丹药品质判定：
- 废丹(失败): 成功率<30%
- 下品丹: 成功率30-50%
- 中品丹: 成功率50-70%  
- 上品丹: 成功率70-85%
- 极品丹: 成功率85-95%
- 神品丹: 成功率95%以上且触发特殊条件

### 常见丹药效果预设：
- 引气丹: 增加修为50-100点, 持续1小时
- 聚灵丹: 回复灵气50-150点, 立即生效
- 疗伤丹: 回复气血100-300点, 解除轻伤状态
- 筑基丹: 筑基期突破成功率+30%, 一生只能服用一次
- 破障丹: 清除心魔状态, 增加突破成功率+20%
`;

// 主要游戏提示词
export const ENHANCED_IN_GAME_PROMPT = [
  '【增强修仙游戏系统】基于角色初始化数据，进行深度修仙游戏体验，返回唯一JSON。',
  '',
  '## 强制数据传输要求：',
  '- 每次AI响应必须包含完整的当前酒馆数据(character.saveData全部内容)',
  '- 所有数值变化必须基于预计算公式，不得随意设定',
  '- 变量修改必须通过tavern_commands精确执行',
  '- 禁止遗漏任何现有数据字段',
  '',
  CULTIVATION_CALCULATION_SYSTEM,
  '',
  COMBAT_CALCULATION_SYSTEM,
  '',
  ALCHEMY_CALCULATION_SYSTEM,
  '',
  '## 修仙专用规则增强：',
  '',
  '### 灵气系统：',
  '- 环境灵气浓度影响修炼效率: 稀薄(-50%), 普通(0%), 浓郁(+30%), 极浓(+70%)',
  '- 灵脉、灵石矿、灵泉等地点有特殊加成',
  '- 不同时辰修炼效果不同: 子时、午时效果最佳(+20%)',
  '',
  '### 天劫系统：',
  '- 金丹期开始面临天劫，每次突破大境界触发',
  '- 天劫强度 = 境界等级 × 天赋系数 × 业力系数',
  '- 渡劫失败: 境界跌落、重伤、甚至身死道消',
  '- 渡劫成功: 获得天劫淬体效果，全属性永久提升',
  '',
  '### 因果业力系统：',
  '- 杀戮、抢夺增加业力值，影响天劫强度和机缘概率',
  '- 行善、救人减少业力值，增加正面机缘',
  '- 业力值范围-1000到+1000，影响NPC态度和事件触发',
  '',
  '### 机缘系统：',
  '- 机缘触发概率 = (气运/10) × (当前活动类型系数) × (地点系数) - (业力惩罚)',
  '- 机缘类型: 天材地宝、古籍秘法、前辈传承、奇遇事件',
  '- 机缘品质与发现地点、角色实力相关',
  '',
  '### 寿命系统：',
  '- 每次突破大境界增加寿命，失败可能损失寿命',
  '- 过度透支灵气、受重伤会减少寿命',
  '- 特殊丹药、天材地宝可延寿',
  '- 寿命不足时，修炼效率下降，容易走火入魔',
  '',
  '## 战斗增强规则：',
  '',
  '### 法宝系统：',
  '- 法宝认主需要滴血或灵气注入',
  '- 法宝等级影响威力: 法器 < 灵器 < 宝器 < 道器 < 仙器',
  '- 法宝可升级，需要对应材料和境界支撑',
  '- 法宝器灵: 高级法宝拥有器灵，可独立战斗',
  '',
  '### 阵法系统：',
  '- 阵法布置需要阵旗、阵石等材料',
  '- 阵法效果: 困敌、杀敌、防护、聚灵等',
  '- 破阵需要对阵法的理解或强行破坏',
  '- 复合阵法威力倍增，但布置难度极高',
  '',
  '### 神通技能系统：',
  '- 神通需要特定功法或血脉才能学习',
  '- 神通威力与境界、理解程度相关',
  '- 禁术类神通威力巨大但有严重副作用',
  '- 天赋神通无需学习，随境界自动觉醒',
  '',
  '## 社交系统增强：',
  '',
  '### 师门宗派：',
  '- 师门贡献影响地位和资源获取',
  '- 宗门任务奖励丰厚但有风险',
  '- 叛出师门会被追杀，声誉大损',
  '- 创建新宗门需要极高境界和资源',
  '',
  '### 道侣系统：',
  '- 双修可以共享修炼成果',
  '- 道侣间的情感状态影响修炼效率',
  '- 道侣陨落会产生心魔，严重影响修炼',
  '',
  '## 预计算值应用示例：',
  '```json',
  '{',
  '  "境界突破计算": {',
  '    "当前修为": 450,',
  '    "所需修为": 500,',
  '    "基础成功率": 90,',
  '    "悟性加成": 8,',
  '    "功法加成": 20,',
  '    "最终成功率": 98',
  '  },',
  '  "战斗伤害计算": {',
  '    "攻击者气血": 180,',
  '    "法宝威力": 50,',
  '    "技能倍率": 1.5,',
  '    "预期伤害": 345',
  '  }',
  '}',
  '```',
  '',
  '## 必须遵循的数据结构：',
  '```javascript',
  'character.saveData = {',
  '  // 原有结构保持不变，新增以下字段：',
  '  修仙数据: {',
  '    业力值: 0, // -1000到+1000',
  '    机缘值: 0, // 影响机缘触发概率',
  '    天劫次数: 0, // 已渡过的天劫次数',
  '    炼丹等级: 0, // 炼丹技能等级',
  '    阵法等级: 0, // 阵法技能等级',
  '    当前环境灵气: \"普通\", // 稀薄/普通/浓郁/极浓',
  '    渡劫状态: null, // 是否在渡劫期',
  '  },',
  '  道侣系统: {',
  '    道侣姓名: null, // 道侣名字或null',
  '    感情状态: \"无\", // 无/暗恋/热恋/深爱/心魔',
  '    双修次数: 0, // 双修总次数',
  '    感情值: 0, // 与道侣的感情深度',
  '  },',
  '  师门宗派: {',
  '    宗门名称: null, // 所属宗门',
  '    宗门地位: \"外门弟子\", // 外门/内门/核心/长老/掌门',
  '    宗门贡献: 0, // 宗门贡献点',
  '    师父姓名: null, // 师父名字',
  '    师兄弟: [], // 同门师兄弟列表',
  '  }',
  '}',
  '```',
  '',
  '## 变量修改方法详解：',
  '',
  '### 境界突破示例：',
  '```json',
  '{',
  '  "set": {',
  '    "character.saveData.玩家角色状态.境界.等级": 2,',
  '    "character.saveData.玩家角色状态.境界.名称": "筑基初期",',
  '    "character.saveData.玩家角色状态.境界.当前进度": 0,',
  '    "character.saveData.玩家角色状态.境界.下一级所需": 1500,',
  '    "character.saveData.玩家角色状态.气血.最大": 250,',
  '    "character.saveData.玩家角色状态.灵气.最大": 200,',
  '    "character.saveData.玩家角色状态.寿命.最大": 150',
  '  },',
  '  "add": {',
  '    "character.saveData.修仙数据.天劫次数": 1',
  '  }',
  '}',
  '```',
  '',
  '### 战斗伤害应用：',
  '```json',
  '{',
  '  "add": {',
  '    "character.saveData.玩家角色状态.气血.当前": -120,',
  '    "character.saveData.玩家角色状态.灵气.当前": -50',
  '  },',
  '  "push": [{',
  '    "key": "character.saveData.玩家角色状态.状态效果",',
  '    "value": {',
  '      "状态名称": "重伤",',
  '      "类型": "debuff",',
  '      "时间": "3天",',
  '      "状态描述": "在激烈战斗中受到重创，气血流失严重，经脉受损，行动能力下降40%，法术威力减少30%，需要及时治疗否则可能留下暗伤影响未来修炼",',
  '      "强度": 7,',
  '      "来源": "战斗受伤",',
  '      "剩余时间": "3天"',
  '    }',
  '  }]',
  '}',
  '```',
  '',
  '### 丹药炼制应用：',
  '```json',
  '{',
  '  "set": {',
  '    "character.saveData.背包.物品.聚灵丹": {',
  '      "物品ID": "聚灵丹",',
  '      "名称": "中品聚灵丹",',
  '      "类型": "其他",',
  '      "品质": {"quality": "黄", "grade": 5},',
  '      "数量": 3,',
  '      "描述": "自制的中品聚灵丹，药效比普通聚灵丹提升50%，可快速回复灵气150点"',
  '    }',
  '  },',
  '  "add": {',
  '    "character.saveData.修仙数据.炼丹等级": 10',
  '  }',
  '}',
  '```',
  '',
  '## 输入数据处理要求：',
  '- 必须读取并传输完整的character.saveData',
  '- 根据当前境界自动计算属性上限',
  '- 检查状态效果是否过期，自动清理',
  '- 验证所有数值变化的合理性',
  '- 确保新增数据结构的完整性',
  '',
  '输入数据（包含完整酒馆数据）：',
  'INPUT_PLACEHOLDER',
  '',
  generateSystemPrompt({
    includeRealmSystem: true,
    includeItemQuality: true,
    includeStatusEffect: true,
    includeNPCSystem: true,
    includeDataStructure: true,
    includeCombatSystem: true,
    includeAlchemySystem: true
  })
].join('\n');

// 特定场景增强提示词
export const CULTIVATION_SCENE_PROMPT = [
  ENHANCED_IN_GAME_PROMPT,
  '',
  '【修炼场景专用】',
  '- 重点计算修炼效率和修为增长',
  '- 考虑环境灵气、功法品质、天赋加成',
  '- 可能触发突破或走火入魔',
  '- 消耗时间和灵气资源'
].join('\n');

export const COMBAT_SCENE_PROMPT = [
  ENHANCED_IN_GAME_PROMPT,
  '',
  '【战斗场景专用】',
  '- 严格按照战斗计算公式处理伤害',
  '- 考虑境界压制和装备加成',
  '- 处理状态效果的战斗影响',
  '- 计算技能消耗和冷却时间'
].join('\n');

export const ALCHEMY_SCENE_PROMPT = [
  ENHANCED_IN_GAME_PROMPT,
  '',
  '【炼丹场景专用】',
  '- 按照炼丹公式计算成功率',
  '- 考虑材料品质和丹炉等级',
  '- 处理炼丹失败的后果',
  '- 更新炼丹技能经验'
].join('\n');

export const BREAKTHROUGH_SCENE_PROMPT = [
  ENHANCED_IN_GAME_PROMPT,
  '',
  '【突破场景专用】',
  '- 严格按照突破公式计算成功率',
  '- 处理突破成功的境界提升',
  '- 处理突破失败的惩罚',
  '- 可能触发天劫事件'
].join('\n');

// 导出函数
export function getEnhancedGamePrompt(sceneType?: '修炼' | '战斗' | '炼丹' | '突破'): string {
  switch (sceneType) {
    case '修炼':
      return CULTIVATION_SCENE_PROMPT;
    case '战斗':
      return COMBAT_SCENE_PROMPT;
    case '炼丹':
      return ALCHEMY_SCENE_PROMPT;
    case '突破':
      return BREAKTHROUGH_SCENE_PROMPT;
    default:
      return ENHANCED_IN_GAME_PROMPT;
  }
}

// 集成初始化数据的完整提示词
export function getIntegratedGamePrompt(initializationData?: any): string {
  const basePrompt = ENHANCED_IN_GAME_PROMPT;
  
  if (initializationData) {
    return [
      basePrompt,
      '',
      '【角色初始化数据集成】',
      CHARACTER_INITIALIZATION_PROMPT,
      '',
      '【当前角色状态】',
      JSON.stringify(initializationData, null, 2)
    ].join('\n');
  }
  
  return basePrompt;
}