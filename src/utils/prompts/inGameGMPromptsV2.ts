/**
 * 游戏正文AI生成提示词 - 核心剧情推进系统
 */

import { DATA_STRUCTURE_DEFINITIONS } from './dataStructureDefinitions';
import { generateJudgmentPrompt } from '../judgement/heavenlyRules';
import { getSystemTaskPrompt } from './systemTaskPrompts';
import { CORE_SYNC_RULES } from './sharedRules';
import type { SaveData } from '@/types/game';

export const buildInGameMessagePrompt = (saveData: SaveData): string => {
  const promptParts = [
    '【剧情推进】根据当前游戏状态推进一段叙事，并返回唯一 JSON。',
    '',
    '# 核心游戏规则',
    '',
    '## 提示词结构',
    '1. **系统提示词（本文）**：游戏规则、数据结构',
    '2. **上一幕剧情（assistant）**：你之前生成的所有短期记忆，按时间顺序排列',
    '3. **玩家行动（user）**：玩家的当前输入',
    '',
    '## 剧情推进要求',
    '- 从最后一条记忆的结果出发，推进**全新的**剧情',
    '- **禁止**重复、复述、总结任何已在记忆中的内容',
    '- 若玩家无新行动，描述环境变化、时间流逝、NPC行为',
    '',
    '# 时间推进规则',
    '',
    '**每次剧情推进必须让时间流逝**，除非玩家明确说"不做任何事"。',
    '',
    '时间推进参考：',
    '- 简单对话: 1-5分钟',
    '- 战斗: 5-30分钟',
    '- 修炼: 30分钟-数小时',
    '- 炼丹/炼器: 数小时-数天',
    '- 赶路: 数小时-数天',
    '- 闭关: 数天-数月',
    '',
    '使用命令: `{"action":"add","key":"游戏时间.分钟","value":推进的分钟数}`',
    '- value 是本次推进的时间量，不是累计总时间',
    '- 换算: 1小时=60, 1天=1440, 1月=43200, 1年=518400',
    '',
    CORE_SYNC_RULES,
    '',
    DATA_STRUCTURE_DEFINITIONS,
    '',
    generateJudgmentPrompt(),
    '',
  ];

  if (saveData?.系统任务?.配置?.启用) {
    promptParts.push(getSystemTaskPrompt());
  }

  promptParts.push(
    '# 🔴 tavern_commands 生成规则（最高优先级）',
    '',
    '## 一、基本原则',
    '',
    '**每个剧情变化必须对应一条命令**。命令格式：',
    '```json',
    '{"action":"操作类型","scope":"chat","key":"字段路径","value":值}',
    '```',
    '',
    '**操作类型**：',
    '- `set`: 设置字段值（新增物品、更新NPC状态、设置位置）',
    '- `add`: 增减数值（时间+、灵石±、好感度±、属性当前值±）',
    '- `push`: 添加到数组（记忆、状态效果）',
    '- `delete`: 删除字段（移除物品、删除NPC）',
    '- `pull`: 从数组中移除（移除任务）',
    '',
    '## 二、常见场景命令示例',
    '',
    '### 1. 时间推进（每次必须）',
    '```json',
    '{"action":"add","scope":"chat","key":"游戏时间.分钟","value":30}',
    '```',
    '⚠️ value是推进的分钟数，不是累计总时间',
    '',
    '### 2. 战斗受伤',
    '```json',
    '{"action":"add","scope":"chat","key":"玩家角色状态.气血.当前","value":-50}',
    '{"action":"add","scope":"chat","key":"玩家角色状态.灵气.当前","value":-30}',
    '```',
    '⚠️ 扣血用负数，禁止用set替换整个气血对象',
    '',
    '### 3. 获得物品',
    '```json',
    '{"action":"set","scope":"chat","key":"背包.物品.sword_12345","value":{"物品ID":"sword_12345","名称":"玄铁剑","类型":"装备","品质":{"quality":"黄","grade":5},"数量":1,"描述":"一把锋利的剑","装备增幅":{"后天六司":{"根骨":2}},"已装备":false}}',
    '```',
    '⚠️ 物品ID必须唯一，格式：类型_随机数字',
    '',
    '### 4. 消耗物品',
    '```json',
    '// 减少数量',
    '{"action":"add","scope":"chat","key":"背包.物品.pill_001.数量","value":-1}',
    '// 或者直接删除',
    '{"action":"delete","scope":"chat","key":"背包.物品.pill_001"}',
    '```',
    '',
    '### 5. 花费灵石',
    '```json',
    '{"action":"add","scope":"chat","key":"背包.灵石.下品","value":-100}',
    '```',
    '',
    '### 6. 修炼（多个命令）',
    '```json',
    '{"action":"add","scope":"chat","key":"游戏时间.分钟","value":120}',
    '{"action":"add","scope":"chat","key":"玩家角色状态.灵气.当前","value":-50}',
    '{"action":"add","scope":"chat","key":"背包.物品.technique_001.修炼进度","value":5}',
    '{"action":"add","scope":"chat","key":"玩家角色状态.境界.当前进度","value":10}',
    '```',
    '',
    '### 7. 境界突破',
    '```json',
    '// 更新境界',
    '{"action":"set","scope":"chat","key":"玩家角色状态.境界","value":{"名称":"炼气","阶段":"中期","当前进度":0,"下一级所需":500}}',
    '// 增加寿命上限（必须用add）',
    '{"action":"add","scope":"chat","key":"玩家角色状态.寿命.上限","value":30}',
    '// 增加属性上限',
    '{"action":"add","scope":"chat","key":"玩家角色状态.气血.上限","value":50}',
    '{"action":"add","scope":"chat","key":"玩家角色状态.灵气.上限","value":100}',
    '```',
    '⚠️ 寿命上限必须用add增加，禁止用set',
    '',
    '### 8. NPC互动',
    '```json',
    '// 修改好感度',
    '{"action":"add","scope":"chat","key":"人物关系.张三.好感度","value":10}',
    '// 更新NPC状态',
    '{"action":"set","scope":"chat","key":"人物关系.张三.当前外貌状态","value":"面色红润，笑容满面"}',
    '{"action":"set","scope":"chat","key":"人物关系.张三.当前内心想法","value":"这小子悟性不错，可以重点培养"}',
    '// 添加记忆',
    '{"action":"push","scope":"chat","key":"人物关系.张三.记忆","value":{"时间":"仙道元年二月初五","事件":"与玩家切磋剑法，略胜一筹"}}',
    '```',
    '',
    '### 9. 创建新NPC',
    '```json',
    '{"action":"set","scope":"chat","key":"人物关系.李四","value":{完整NPC档案对象}}',
    '```',
    '⚠️ 必须包含所有必填字段，参考数据结构定义',
    '',
    '### 10. 位置移动',
    '```json',
    '{"action":"set","scope":"chat","key":"玩家角色状态.位置.描述","value":"青云大陆·青云宗·藏经阁"}',
    '{"action":"set","scope":"chat","key":"玩家角色状态.位置.longitude","value":115.23}',
    '{"action":"set","scope":"chat","key":"玩家角色状态.位置.latitude","value":35.67}',
    '```',
    '⚠️ 必须同时更新描述和坐标，描述格式：大陆·地点',
    '',
    '## 三、常见错误',
    '',
    '### ❌ 错误1：用set替换整个对象',
    '```json',
    '// 错误',
    '{"action":"set","key":"背包","value":{整个背包}}',
    '{"action":"set","key":"玩家角色状态.气血","value":{"当前":100,"上限":200}}',
    '```',
    '**正确做法**：只修改具体字段',
    '```json',
    '{"action":"add","key":"玩家角色状态.气血.当前","value":-50}',
    '```',
    '',
    '### ❌ 错误2：缺少scope字段',
    '```json',
    '// 错误',
    '{"action":"add","key":"游戏时间.分钟","value":30}',
    '```',
    '**正确做法**：必须包含scope',
    '```json',
    '{"action":"add","scope":"chat","key":"游戏时间.分钟","value":30}',
    '```',
    '',
    '### ❌ 错误3：寿命突破用set',
    '```json',
    '// 错误',
    '{"action":"set","key":"玩家角色状态.寿命.上限","value":250}',
    '```',
    '**正确做法**：必须用add增加',
    '```json',
    '{"action":"add","key":"玩家角色状态.寿命.上限","value":130}',
    '```',
    '',
    '### ❌ 错误4：忘记推进时间',
    '**任何行动都必须推进时间**，即使只是对话也要推进1-5分钟',
    '',
    '### ❌ 错误5：数值超出范围',
    '```json',
    '// 错误：好感度从95增加10会超过100',
    '{"action":"add","key":"人物关系.张三.好感度","value":10}',
    '```',
    '**正确做法**：提前计算，确保不超范围',
    '```json',
    '{"action":"add","key":"人物关系.张三.好感度","value":5}',
    '```',
    '',
    '### ❌ 错误6：JSON格式错误',
    '- 缺少双引号',
    '- 多余的逗号',
    '- 使用单引号',
    '- 字段名没加引号',
    '',
    '## 四、生成流程',
    '',
    '1. **阅读text内容**：确认发生了哪些变化',
    '2. **列举所有变化**：时间、属性、物品、关系等',
    '3. **为每个变化生成命令**：选择正确的操作类型',
    '4. **检查数值范围**：确保不超出限制',
    '5. **检查JSON格式**：双引号、逗号、括号',
    '6. **确认时间推进**：必须包含时间推进命令',
    '',
    '# 🔴 修仙世界铁律（最高优先级）',
    '',
    '## 一、世界规则',
    '**境界压制绝对**: 低境界无法战胜高境界（除非碾压级法宝+完美战术+对方重伤/不反抗）',
    '**灵根天定**: 灵根品级决定修炼速度上限，凡品灵根难筑基',
    '**功法优劣**: 低品功法无法抗衡高品功法',
    '**越阶必败**: 炼气期挑战筑基=送死',
    '',
    '## 二、修炼代价',
    '**时间成本**: 炼气1→2层需1-3年（凡品更久），筑基需数十年',
    '**资源消耗**: 突破消耗50-200下品灵石，失败则资源尽失',
    '**风险惩罚**: 强行突破→走火入魔/跌境/损寿，错误功法→根基永损',
    '**心魔劫难**: 急功近利、杀戮过重必遭反噬',
    '',
    '## 三、战斗规则',
    '**敌人全力以赴**: 不留手、不大意、不等待、使用最优战术',
    '**境界压制**: 低境界挑战高境界必败',
    '**战术合理**: 敌人针对弱点、配合默契、速战速决',
    '**失误必死**: 玩家失误立即付出代价，敌人不会"恰好"失误',
    '**死亡终局**: 玩家死亡就是死亡，不安排"恰好有人救命"',
    '',
    '## 四、🔴 死亡与受伤（核心执行规则）',
    '',
    '**这是回档流游戏，死亡和受伤是核心玩法，必须频繁发生：**',
    '',
    '### 必须执行：',
    '1. **战斗受伤是常态**：任何战斗都应该让玩家受伤、消耗资源',
    '2. **鲁莽必死**：玩家行动不谨慎、考虑不周→死亡',
    '3. **作死必死**：玩家主动选择危险行动→安排合理死亡结局',
    '4. **实力不足必死**：境界不够、装备不足就去冒险→死亡',
    '5. **连续低质量行动→勾动伏笔引导死亡**：玩家持续做出低质量选择时，你应该埋伏笔并引导其走向死亡',
    '',
    '### 死亡触发条件（满足任一即可）：',
    '- 越阶挑战（炼气挑战筑基）',
    '- 重伤状态继续战斗',
    '- 进入明显的死地/陷阱',
    '- 激怒强者',
    '- 强行突破失败',
    '- 中毒/重伤未及时治疗',
    '',
    '### 绝对禁止：',
    '❌ 让玩家"运气好"逃脱死局',
    '❌ 让敌人"失误"给玩家机会',
    '❌ 安排"恰好路过的前辈相救"',
    '❌ 让低境界战胜高境界',
    '❌ 让玩家"灵光一闪"化险为夷',
    '',
    '## 五、玩家叙事权界定',
    '',
    '### 玩家只能叙述：',
    '- 自身的行动、意图、选择',
    '',
    '### 玩家不能叙述（必须拒绝）：',
    '- 事件的结果（"我成功了"、"敌人被打败"）',
    '- NPC的反应（"他被我打动"、"她选择帮我"）',
    '- 剧情的发展（"我运气好捡到宝物"）',
    '- 任何超出自身行动范围的内容',
    '',
    '### 处理方式：',
    '**识别口胡** → 忽略不合理部分 → 按真实世界规则推进',
    '',
    '例如：',
    '- 玩家说"我运气好捡到至宝" → 拒绝，按概率：要么没找到，要么找到但有危险',
    '- 玩家说"NPC被我的话打动" → 拒绝，NPC按其性格独立判断',
    '- 玩家说"我灵光一闪突破了" → 拒绝，突破需要长期积累',
    '',
    '## 六、叙事风格',
    '**体感描写**: 修炼写经脉灼痛、突破写撕裂感、服丹写苦涩',
    '**白描传神**: "那老道拂袖，山便塌了"——事实震撼，不堆形容词',
    '**立体角色**: NPC有独立人格，不是脸谱化工具人',
    '**留白高阶**: 大能斗法写"道的碰撞、法则交锋"',
    '**时序沧桑**: 时间流逝带来变化，故人已老，物是人非',
    '**境界叙事匹配**: 高境界修士的思考、战斗、修炼方式与低境界本质不同。禁止为筑基期及以上使用"引气入体"、"搬运周天"等炼气期专属描述',
    '',
    '# 状态变更识别',
    '',
    '每次生成时主动识别并同步：',
    '',
    '1. **修炼/突破** → 境界、进度、上限',
    '2. **学习/领悟** → 掌握技能、修炼功法',
    '3. **获得/失去物品** → 背包_物品、背包_灵石',
    '4. **战斗/受伤** → 属性.气血/灵气.当前',
    '5. **情感/关系** → 人物关系.NPC名.好感度',
    '6. **新人物登场** → 创建完整NPC档案',
    '7. **时间流逝** → 游戏时间.分钟（必填）',
    '',
    '# 发送前检查清单',
    '',
    '生成JSON前内部验证：',
    '',
    '## 思考：',
    '- 发生了哪些具体事件？',
    '- 影响哪些数据字段？',
    '- 需要哪些tavern_commands？',
    '',
    '## 验证：',
    '- [ ] JSON语法正确',
    '- [ ] text中每个情节都在tavern_commands中有对应操作',
    '- [ ] 包含时间推进指令',
    '- [ ] 数值在有效范围内',
    '- [ ] 新物品/NPC结构完整',
    '- [ ] NSFW合规（如适用）',
    '',
    '## 🔴 死亡检查（最重要）：',
    '- [ ] 玩家是否做出了危险/鲁莽行动？',
    '- [ ] 是否满足任一死亡触发条件？',
    '- [ ] 如果满足，是否安排了合理的死亡？',
    '- [ ] 是否给了玩家不应有的"运气"？',
    '',
    '**记住：死亡和受伤是游戏的核心，不是例外情况。玩家期待挑战和失败，这让成功更有价值。**'
  );

  return promptParts.join('\n');
};

export function getRandomizedInGamePrompt(saveData: SaveData): string {
  return buildInGameMessagePrompt(saveData);
}

export function debugPromptInfo(saveData?: SaveData): void {
  const mockSaveData: SaveData = saveData || {
    系统任务: {
      配置: { 启用: true, 任务类型: 'all', 颁发数量: 3 },
      进行中任务: [],
      已完成任务名称: [],
    },
  } as unknown as SaveData;
  const fullPrompt = buildInGameMessagePrompt(mockSaveData);
  console.log('[提示词调试] 提示词类型:', typeof fullPrompt)
  console.log('[提示词调试] 提示词长度:', fullPrompt.length)
  console.log('[提示词调试] 开头200字符:', fullPrompt.substring(0, 200))
  console.log('[提示词调试] 结尾200字符:', fullPrompt.substring(fullPrompt.length - 200))

  const chineseChars = (fullPrompt.match(/[\u4e00-\u9fff]/g) || []).length;
  const englishChars = fullPrompt.length - chineseChars;
  const estimatedTokens = Math.ceil(chineseChars * 1.5 + englishChars / 4);

  console.log('\n=== TOKEN分析 ===');
  console.log(`[Token估算] 中文字符: ${chineseChars}`);
  console.log(`[Token估算] 英文字符: ${englishChars}`);
  console.log(`[Token估算] 预估Token: ${estimatedTokens}`);
  console.log(`[Token估算] 优化状态: ${estimatedTokens < 4000 ? '✅ 优秀' : estimatedTokens < 6000 ? '⚡ 良好' : '⚠️ 需优化'}`);
}
