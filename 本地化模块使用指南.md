# è„±ç¦»é…’é¦†æœ¬åœ°åŒ–æ¨¡å—ä½¿ç”¨æŒ‡å—

è¿™ä¸ªç›®å½•åŒ…å«äº†å®Œå…¨è„±ç¦»SillyTavernï¼ˆé…’é¦†ï¼‰ä¾èµ–çš„æœ¬åœ°åŒ–æ›¿ä»£æ¨¡å—ã€‚è¿™äº›æ¨¡å—æä¾›äº†ä¸–ç•Œä¹¦ç®¡ç†ã€å˜é‡ç³»ç»Ÿå’ŒAIè°ƒç”¨çš„å®Œæ•´åŠŸèƒ½ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ LocalLorebook.d.ts      # ä¸–ç•Œä¹¦ç³»ç»Ÿç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ LocalVariable.d.ts      # å˜é‡ç³»ç»Ÿç±»å‹å®šä¹‰
â”‚   â””â”€â”€ LocalAI.d.ts            # AIæä¾›å•†ç³»ç»Ÿç±»å‹å®šä¹‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ lorebook/
â”‚   â”‚   â””â”€â”€ LocalLorebookManager.ts  # ä¸–ç•Œä¹¦ç®¡ç†å™¨å®ç°
â”‚   â”œâ”€â”€ variable/
â”‚   â”‚   â””â”€â”€ LocalVariableManager.ts  # å˜é‡ç®¡ç†å™¨å®ç°
â”‚   â””â”€â”€ ai/
â”‚       â””â”€â”€ LocalAIManager.ts        # AIæä¾›å•†ç®¡ç†å™¨å®ç°
â””â”€â”€ è„±ç¦»é…’é¦†è®¾è®¡æ–‡æ¡£.md              # å®Œæ•´è®¾è®¡æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä¸–ç•Œä¹¦ç³»ç»Ÿ

```typescript
import { LocalLorebookManager } from './services/lorebook/LocalLorebookManager';
import { EntryCategory } from './types/LocalLorebook';

// åˆå§‹åŒ–ä¸–ç•Œä¹¦ç®¡ç†å™¨
const lorebookManager = new LocalLorebookManager();
await lorebookManager.initialize();

// åˆ›å»ºæ–°ä¸–ç•Œä¹¦
const lorebook = lorebookManager.createLorebook('ä¿®ä»™ä¸–ç•Œ', 'åŸºç¡€ä¿®ä»™è®¾å®š');

// æ·»åŠ æ¡ç›®
const entry = lorebookManager.addEntry(lorebook.id, {
  title: 'é’äº‘å®—',
  content: 'ä¸œèƒœç¥æ´²ç¬¬ä¸€å¤§å®—ï¼Œå‰‘ä¿®åœ£åœ°ï¼Œå±±é—¨è¿ç»µå…«ç™¾é‡Œã€‚',
  keywords: ['é’äº‘å®—', 'é’äº‘', 'æ­£é“'],
  category: EntryCategory.ORGANIZATION,
  enabled: true,
  priority: 80,
  position: 'before_character'
});

// æŸ¥æ‰¾è§¦å‘çš„æ¡ç›®
const text = 'ç©å®¶æ¥åˆ°äº†é’äº‘å®—å±±é—¨å‰';
const matches = lorebookManager.findTriggeredEntries(lorebook.id, text);

// æ„å»ºAIä¸Šä¸‹æ–‡
const context = lorebookManager.buildLorebookContext(matches);
```

### 2. å˜é‡ç³»ç»Ÿ

```typescript
import { LocalVariableManager } from './services/variable/LocalVariableManager';

// åˆå§‹åŒ–å˜é‡ç®¡ç†å™¨
const variableManager = new LocalVariableManager();
await variableManager.initialize();

// è®¾ç½®ä¸åŒä½œç”¨åŸŸçš„å˜é‡
variableManager.set('global', 'world_time', 'å¼€å…ƒå…ƒå¹´æ˜¥');
variableManager.set('character', 'name', 'å¼ ä¸‰');
variableManager.set('character', 'level', 1);
variableManager.set('chat', 'current_location', 'é’äº‘å±±');

// æ•°ç»„æ“ä½œ
variableManager.push('chat', 'inventory', { 
  name: 'é£å‰‘', 
  type: 'æ³•å®', 
  description: 'ä¸€æŸ„æ™®é€šçš„é£å‰‘' 
});

// æ•°å€¼æ“ä½œ
variableManager.add('character', 'level', 1); // å‡çº§

// ç›‘å¬å˜é‡å˜åŒ–
const watcherId = variableManager.watch('character', 'level', (event) => {
  console.log(`è§’è‰²ç­‰çº§ä» ${event.oldValue} å˜ä¸º ${event.newValue}`);
});

// æ‰¹é‡æ“ä½œ
variableManager.startBatch();
variableManager.set('character', 'hp', 100);
variableManager.set('character', 'mp', 50);
await variableManager.commitBatch();
```

### 3. AIæä¾›å•†ç³»ç»Ÿ

```typescript
import { LocalAIManager } from './services/ai/LocalAIManager';

// åˆå§‹åŒ–AIç®¡ç†å™¨
const aiManager = new LocalAIManager();
await aiManager.initialize();

// æ·»åŠ OpenAIæä¾›å•†
aiManager.addProvider('my-openai', {
  type: 'openai',
  name: 'My OpenAI',
  apiKey: 'sk-your-api-key-here',
  apiUrl: 'https://api.openai.com/v1/chat/completions',
  model: 'gpt-4',
  defaultParams: {
    temperature: 0.8,
    maxTokens: 1000
  }
});

// æ·»åŠ æœ¬åœ°AIæä¾›å•†ï¼ˆå¦‚Ollamaï¼‰
aiManager.addProvider('local-llama', {
  type: 'local',
  name: 'Local Llama',
  apiUrl: 'http://localhost:11434/api/generate',
  model: 'llama2',
  defaultParams: {
    temperature: 0.8,
    maxTokens: 1000
  }
});

// è®¾ç½®æ´»è·ƒæä¾›å•†
aiManager.setActiveProvider('my-openai');

// ç”Ÿæˆå†…å®¹
const response = await aiManager.generate({
  prompt: 'è¯·æè¿°ä¸€ä¸ªä¿®ä»™é—¨æ´¾çš„è®¾å®š',
  systemPrompt: 'ä½ æ˜¯ä¸€ä½ç²¾é€šä¸œæ–¹ç„å¹»è®¾å®šçš„ä½œå®¶',
  temperature: 1.0
});

console.log('ç”Ÿæˆç»“æœ:', response.text);
console.log('ä½¿ç”¨Token:', response.usage?.totalTokens);
```

## ğŸ”§ é›†æˆåˆ°ç°æœ‰é¡¹ç›®

### æ›¿æ¢é…’é¦†ä¸–ç•Œä¹¦åŠŸèƒ½

```typescript
// æ—§çš„é…’é¦†ä»£ç 
// import { createWorldLorebookEntry } from './utils/tavern';

// æ–°çš„æœ¬åœ°ä»£ç 
import { LocalLorebookManager } from './services/lorebook/LocalLorebookManager';

const lorebookManager = new LocalLorebookManager();

// æ›¿æ¢å‡½æ•°
async function createWorldLorebookEntry(worldName: string, worldDescription: string) {
  const lorebook = lorebookManager.getActiveLorebook();
  if (lorebook) {
    lorebookManager.addEntry(lorebook.id, {
      title: worldName,
      content: worldDescription,
      keywords: [worldName],
      category: EntryCategory.WORLD_SETTING,
      enabled: true,
      priority: 50,
      position: 'before_character'
    });
  }
}
```

### æ›¿æ¢é…’é¦†å˜é‡ç³»ç»Ÿ

```typescript
// æ—§çš„é…’é¦†ä»£ç 
// import { getTavernHelper } from './utils/tavern';

// æ–°çš„æœ¬åœ°ä»£ç 
import { LocalVariableManager } from './services/variable/LocalVariableManager';

const variableManager = new LocalVariableManager();

// æ›¿æ¢å‡½æ•°
function getTavernHelper() {
  return {
    getVariables: (options: { type: string }) => {
      return variableManager.getAll(options.type as any);
    },
    insertOrAssignVariables: (data: Record<string, any>, options: { type: string }) => {
      variableManager.setMultiple(options.type as any, data);
    }
  };
}
```

### æ›¿æ¢é…’é¦†AIç”Ÿæˆ

```typescript
// æ—§çš„é…’é¦†ä»£ç 
// import { generateItemWithTavernAI } from './utils/tavernAI';

// æ–°çš„æœ¬åœ°ä»£ç 
import { LocalAIManager } from './services/ai/LocalAIManager';

const aiManager = new LocalAIManager();

// æ›¿æ¢å‡½æ•°
async function generateItemWithTavernAI<T>(prompt: string, typeName: string): Promise<T> {
  const response = await aiManager.generate({
    prompt,
    temperature: 1.2,
    maxTokens: 512
  });
  
  // è§£æJSONå“åº”
  const jsonMatch = response.text.match(/\\{[\\s\\S]*\\}/);
  if (!jsonMatch) {
    throw new Error(`AIè¿”å›å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONç»“æ„`);
  }
  
  return JSON.parse(jsonMatch[0]) as T;
}
```

## âš™ï¸ é…ç½®é€‰é¡¹

### ä¸–ç•Œä¹¦é…ç½®

```typescript
// åœ¨lorebookåˆ›å»ºæ—¶é…ç½®
const lorebook = lorebookManager.createLorebook('ä¿®ä»™ä¸–ç•Œ', 'æè¿°');
lorebook.config = {
  maxTriggeredEntries: 15,     // æœ€å¤§åŒæ—¶è§¦å‘æ¡ç›®æ•°
  autoTrigger: true,           // è‡ªåŠ¨è§¦å‘
  matchMode: 'partial'         // åŒ¹é…æ¨¡å¼: 'exact' | 'partial' | 'fuzzy'
};
```

### å˜é‡æŒä¹…åŒ–é…ç½®

```typescript
// åœ¨åˆå§‹åŒ–æ—¶é…ç½®å­˜å‚¨ç­–ç•¥
const variableManager = new LocalVariableManager();
variableManager.persistenceConfig = {
  global: 'localStorage',      // å…¨å±€å˜é‡ç”¨localStorage
  character: 'indexedDB',      // è§’è‰²å˜é‡ç”¨IndexedDB
  chat: 'sessionStorage',      // å¯¹è¯å˜é‡ç”¨sessionStorage
  session: 'memory'            // ä¼šè¯å˜é‡ä»…å†…å­˜
};
```

### AIæä¾›å•†é…ç½®

```typescript
// é…ç½®é‡è¯•å’Œè¶…æ—¶
aiManager.addProvider('my-provider', {
  type: 'openai',
  name: 'My Provider',
  apiKey: 'your-key',
  model: 'gpt-4',
  timeout: 30000,              // 30ç§’è¶…æ—¶
  retry: {
    maxAttempts: 3,            // æœ€å¤§é‡è¯•æ¬¡æ•°
    delay: 1000                // é‡è¯•å»¶è¿Ÿ
  },
  rateLimit: {
    requestsPerMinute: 60,     // æ¯åˆ†é’Ÿè¯·æ±‚é™åˆ¶
    tokensPerMinute: 10000     // æ¯åˆ†é’ŸTokené™åˆ¶
  },
  defaultParams: {
    temperature: 0.8,
    maxTokens: 1000
  }
});
```

## ğŸ“Š ç›‘æ§å’Œç»Ÿè®¡

### ä¸–ç•Œä¹¦ç»Ÿè®¡

```typescript
const stats = lorebookManager.getLorebookStats(lorebook.id);
console.log('ä¸–ç•Œä¹¦ç»Ÿè®¡:', {
  totalEntries: stats.totalEntries,
  enabledEntries: stats.enabledEntries,
  categoryCounts: stats.categoryCounts,
  averageContentLength: stats.averageContentLength
});
```

### å˜é‡ç»Ÿè®¡

```typescript
const stats = variableManager.getStats();
console.log('å˜é‡ç»Ÿè®¡:', {
  å„ä½œç”¨åŸŸæ•°é‡: stats.counts,
  å„ç±»å‹æ•°é‡: stats.types,
  æ€»å­˜å‚¨å¤§å°: stats.totalSize
});
```

### AIä½¿ç”¨ç»Ÿè®¡

```typescript
const stats = aiManager.getProviderStats('my-openai');
console.log('AIç»Ÿè®¡:', {
  æ€»è¯·æ±‚æ•°: stats.totalRequests,
  æˆåŠŸç‡: stats.successfulRequests / stats.totalRequests,
  å¹³å‡å“åº”æ—¶é—´: stats.averageResponseTime,
  æ€»Tokenæ¶ˆè€—: stats.totalTokensUsed
});
```

## ğŸ”„ è¿ç§»ç­–ç•¥

### æ¸è¿›å¼è¿ç§»

1. **ç¬¬ä¸€é˜¶æ®µï¼šå¹¶è¡Œè¿è¡Œ**
   - ä¿æŒç°æœ‰é…’é¦†åŠŸèƒ½
   - åŒæ—¶åˆå§‹åŒ–æœ¬åœ°ç³»ç»Ÿ
   - é€šè¿‡é…ç½®å¼€å…³é€‰æ‹©ä½¿ç”¨å“ªå¥—ç³»ç»Ÿ

2. **ç¬¬äºŒé˜¶æ®µï¼šåŠŸèƒ½è¿ç§»**
   - é€æ­¥å°†åŠŸèƒ½ä»é…’é¦†è¿ç§»åˆ°æœ¬åœ°
   - ä¿ç•™é…’é¦†æ¥å£ä½œä¸ºåå¤‡æ–¹æ¡ˆ
   - å®ç°æ•°æ®å¯¼å…¥å¯¼å‡º

3. **ç¬¬ä¸‰é˜¶æ®µï¼šå®Œå…¨ç‹¬ç«‹**
   - ç§»é™¤é…’é¦†ä¾èµ–ä»£ç 
   - æ›´æ–°æ‰€æœ‰è°ƒç”¨ç‚¹
   - ä¼˜åŒ–æœ¬åœ°ç³»ç»Ÿæ€§èƒ½

### æ•°æ®è¿ç§»å·¥å…·

```typescript
// ä»é…’é¦†å¯¼å‡ºæ•°æ®
async function exportFromTavern() {
  const helper = getTavernHelper();
  
  // å¯¼å‡ºå˜é‡
  const globalVars = await helper.getVariables({ type: 'global' });
  const chatVars = await helper.getVariables({ type: 'chat' });
  
  // å¯¼å‡ºä¸–ç•Œä¹¦
  const lorebooks = await helper.getLorebooks();
  
  return { variables: { global: globalVars, chat: chatVars }, lorebooks };
}

// å¯¼å…¥åˆ°æœ¬åœ°ç³»ç»Ÿ
async function importToLocal(data: any) {
  // å¯¼å…¥å˜é‡
  variableManager.setMultiple('global', data.variables.global);
  variableManager.setMultiple('chat', data.variables.chat);
  
  // å¯¼å…¥ä¸–ç•Œä¹¦
  for (const lorebookData of data.lorebooks) {
    const lorebook = lorebookManager.createLorebook(
      lorebookData.name, 
      lorebookData.description
    );
    
    for (const entryData of lorebookData.entries) {
      lorebookManager.addEntry(lorebook.id, entryData);
    }
  }
}
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ä¸–ç•Œä¹¦æ¡ç›®ä¸è§¦å‘**
   - æ£€æŸ¥æ¡ç›®æ˜¯å¦å¯ç”¨
   - éªŒè¯å…³é”®è¯æ˜¯å¦æ­£ç¡®
   - è°ƒæ•´åŒ¹é…æ¨¡å¼

2. **å˜é‡æŒä¹…åŒ–å¤±è´¥**
   - æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨é™åˆ¶
   - éªŒè¯å­˜å‚¨é€‚é…å™¨é…ç½®
   - æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

3. **AIè°ƒç”¨å¤±è´¥**
   - éªŒè¯APIå¯†é’¥å’ŒURL
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - æŸ¥çœ‹è¯·æ±‚å‚æ•°æ˜¯å¦æ­£ç¡®

### è°ƒè¯•æŠ€å·§

```typescript
// å¯ç”¨è¯¦ç»†æ—¥å¿—
console.log('[DEBUG] ä¸–ç•Œä¹¦æ¡ç›®åŒ¹é…:', matches);
console.log('[DEBUG] å˜é‡çŠ¶æ€:', variableManager.getAll('character'));
console.log('[DEBUG] AIè¯·æ±‚:', request);
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**
   - ä¸–ç•Œä¹¦æ¡ç›®æ•°é‡è¿‡å¤šä¼šå½±å“åŒ¹é…æ€§èƒ½
   - å˜é‡è¿‡å¤šä¼šå ç”¨å†…å­˜å’Œå­˜å‚¨ç©ºé—´
   - AIè°ƒç”¨æœ‰é¢‘ç‡é™åˆ¶

2. **å®‰å…¨è€ƒè™‘**
   - APIå¯†é’¥ä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
   - æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
   - éªŒè¯ç”¨æˆ·è¾“å…¥

3. **å…¼å®¹æ€§**
   - æ£€æŸ¥æµè§ˆå™¨APIæ”¯æŒæƒ…å†µ
   - å¤„ç†å­˜å‚¨é™åˆ¶å’Œå¼‚å¸¸
   - æä¾›é™çº§æ–¹æ¡ˆ

## ğŸ”® æœªæ¥æ‰©å±•

è¿™äº›æ¨¡å—è®¾è®¡ä¸ºå¯æ‰©å±•çš„æ¶æ„ï¼Œå¯ä»¥è½»æ¾æ·»åŠ ï¼š

- æ–°çš„å­˜å‚¨é€‚é…å™¨ï¼ˆå¦‚äº‘ç«¯åŒæ­¥ï¼‰
- æ–°çš„AIæä¾›å•†ï¼ˆå¦‚Google Geminiï¼‰
- é«˜çº§ä¸–ç•Œä¹¦åŠŸèƒ½ï¼ˆå¦‚æ¡ç›®ä¾èµ–å…³ç³»ï¼‰
- å˜é‡ç±»å‹éªŒè¯å’Œçº¦æŸ
- å®æ—¶åä½œåŠŸèƒ½

é€šè¿‡è¿™å¥—æœ¬åœ°åŒ–ç³»ç»Ÿï¼Œä½ çš„é¡¹ç›®å°†å®Œå…¨æ‘†è„±å¯¹SillyTavernçš„ä¾èµ–ï¼ŒåŒæ—¶è·å¾—æ›´å¥½çš„æ€§èƒ½ã€çµæ´»æ€§å’Œå¯æ§æ€§ã€‚