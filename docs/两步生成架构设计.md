# ä¸¤æ­¥ç”Ÿæˆæ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ ¸å¿ƒæ€è·¯

### ç°çŠ¶é—®é¢˜
```typescript
// å½“å‰ï¼šä¸€æ¬¡æ€§ç”Ÿæˆï¼ˆAIå‹åŠ›å¤§ï¼Œå®¹æ˜“å‡ºé”™ï¼‰
const response = await AI.generate({
  prompt: ä¸–ç•Œä¹¦ + é¢„è®¾ + æ•°æ®ç»“æ„è§„èŒƒ + ç”¨æˆ·è¾“å…¥,
  output: { text, mid_term_memory, tavern_commands }
})
```

**é—®é¢˜**ï¼š
- AIè¦åŒæ—¶è€ƒè™‘"æ•…äº‹å¥½çœ‹" + "æ•°æ®æ ¼å¼æ­£ç¡®"
- æç¤ºè¯å·¨å¤§ï¼ˆ8000+ tokensï¼‰
- æ ¼å¼é”™è¯¯ç‡é«˜ï¼ˆ~15-20%ï¼‰

### æ–°æ–¹æ¡ˆï¼šä¸¤æ­¥ç”Ÿæˆ

```typescript
// æ­¥éª¤1ï¼šçº¯å™äº‹ï¼ˆAIä¸“æ³¨è®²æ•…äº‹ï¼‰
const narrative = await AI.generate({
  prompt: ä¸–ç•Œä¹¦ + é¢„è®¾ + ç”¨æˆ·è¾“å…¥,  // ä¸å«æ ¼å¼è§„èŒƒï¼
  output: string  // çº¯æ–‡æœ¬ï¼Œæ— æ ¼å¼è¦æ±‚
})

// æ­¥éª¤2ï¼šæ•°æ®è½¬æ¢ï¼ˆAIä¸“æ³¨æ•°æ®å‡†ç¡®æ€§ï¼‰
const data = await AI.generate({
  prompt: æ•°æ®ç»“æ„è§„èŒƒ + å½“å‰saveData + narrative,
  output: { mid_term_memory, tavern_commands }  // åªè´Ÿè´£æ•°æ®
})

// åˆå¹¶
return { text: narrative, ...data }
```

**ä¼˜åŠ¿**ï¼š
- æ­¥éª¤1ï¼š3000 tokensï¼Œå¿«é€Ÿï¼Œä¸“æ³¨å™äº‹è´¨é‡
- æ­¥éª¤2ï¼š5000 tokensï¼Œæ…¢ä½†å‡†ç¡®ï¼Œæ ¼å¼é”™è¯¯ç‡ <3%
- èŒè´£åˆ†ç¦»ï¼Œæ˜“äºè°ƒè¯•å’Œä¼˜åŒ–

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ä»£ç ç»“æ„

```
src/utils/
â”œâ”€â”€ generators/
â”‚   â”œâ”€â”€ twoStepGenerator.ts          # æ–°å¢ï¼šä¸¤æ­¥ç”Ÿæˆä¸»é€»è¾‘
â”‚   â””â”€â”€ gameMasterGenerators.ts      # åŸæœ‰ï¼ˆä¿æŒå…¼å®¹ï¼‰
â”‚
â”œâ”€â”€ prompts/
â”‚   â”œâ”€â”€ step1_narrative.ts           # æ–°å¢ï¼šæ­¥éª¤1æç¤ºè¯
â”‚   â”œâ”€â”€ step2_dataConversion.ts      # æ–°å¢ï¼šæ­¥éª¤2æç¤ºè¯
â”‚   â”‚
â”‚   â””â”€â”€ legacy/                      # æ—§æç¤ºè¯å¤‡ä»½
â”‚       â”œâ”€â”€ é…’é¦†åŠ©æ‰‹.txr
â”‚       â”œâ”€â”€ é…’é¦†æŒ‡ä»¤æç¤º_ä¼˜åŒ–.txr
â”‚       â””â”€â”€ åˆ¤å®šç³»ç»Ÿ.txr
â”‚
â””â”€â”€ validators/
    â””â”€â”€ commandValidator.ts          # æ–°å¢ï¼šæ•°æ®éªŒè¯å™¨
```

### æ ¸å¿ƒæ–‡ä»¶

#### `twoStepGenerator.ts` - ä¸»é€»è¾‘

```typescript
import type { GM_Response, TavernCommand } from '@/types/AIGameMaster';
import type { SaveData } from '@/types/game';

/**
 * ä¸¤æ­¥ç”Ÿæˆä¸»å‡½æ•°
 */
export async function generateResponseTwoStep(
  userInput: string,
  saveData: SaveData,
  options?: {
    useStreaming?: boolean;
    onNarrativeReady?: (text: string) => void;
  }
): Promise<GM_Response> {

  // ============ æ­¥éª¤1ï¼šç”Ÿæˆçº¯å™äº‹æ–‡æœ¬ ============
  console.log('[æ­¥éª¤1] å¼€å§‹ç”Ÿæˆå™äº‹æ–‡æœ¬');

  const narrativePrompt = buildNarrativePrompt(userInput, saveData);
  const narrativeText = await callAI(narrativePrompt, {
    maxTokens: 2000,  // çº¯æ–‡æœ¬ï¼Œå¯ä»¥é•¿ä¸€ç‚¹
    temperature: 0.9   // æ›´æœ‰åˆ›æ„
  });

  // å¯é€‰ï¼šç«‹å³æ˜¾ç¤ºæ–‡æœ¬ç»™ç”¨æˆ·ï¼ˆæå‡ä½“éªŒï¼‰
  if (options?.onNarrativeReady) {
    options.onNarrativeReady(narrativeText);
  }

  console.log('[æ­¥éª¤1] å™äº‹æ–‡æœ¬ç”Ÿæˆå®Œæˆï¼Œå­—æ•°:', narrativeText.length);

  // ============ æ­¥éª¤2ï¼šç”Ÿæˆæ•°æ®æŒ‡ä»¤ ============
  console.log('[æ­¥éª¤2] å¼€å§‹ç”Ÿæˆæ•°æ®æŒ‡ä»¤');

  const conversionPrompt = buildConversionPrompt(
    narrativeText,
    saveData
  );

  const dataResult = await callAI(conversionPrompt, {
    maxTokens: 1500,
    temperature: 0.3   // æ›´ç²¾ç¡®
  });

  console.log('[æ­¥éª¤2] æ•°æ®æŒ‡ä»¤ç”Ÿæˆå®Œæˆ');

  // ============ éªŒè¯ä¸è¿”å› ============
  validateCommands(dataResult.tavern_commands, saveData);

  return {
    text: narrativeText,
    mid_term_memory: dataResult.mid_term_memory,
    tavern_commands: dataResult.tavern_commands
  };
}

/**
 * æ„å»ºæ­¥éª¤1æç¤ºè¯ï¼šçº¯å™äº‹
 */
function buildNarrativePrompt(userInput: string, saveData: SaveData): string {
  // æå–ç®€åŒ–çš„ä¸Šä¸‹æ–‡ï¼ˆä¸éœ€è¦å®Œæ•´æ•°æ®ï¼‰
  const context = {
    è§’è‰²: `${saveData.è§’è‰²åŸºç¡€ä¿¡æ¯.åå­—}, ${saveData.å¢ƒç•Œ?.åç§°}`,
    ä½ç½®: saveData.ä½ç½®?.æè¿°,
    æ—¶é—´: `${saveData.æ¸¸æˆæ—¶é—´?.å¹´}å¹´${saveData.æ¸¸æˆæ—¶é—´?.æœˆ}æœˆ`,
    è¿‘æœŸäº‹ä»¶: saveData.è®°å¿†?.ä¸­æœŸè®°å¿†?.slice(-3)
  };

  return `
ä½ æ˜¯ä¿®ä»™ä¸–ç•Œã€Šå¤§é“æœå¤©ã€‹çš„å™äº‹è€…ã€‚

# å½“å‰çŠ¶æ€
${JSON.stringify(context, null, 2)}

# ç©å®¶æŒ‡ä»¤
${userInput}

# ä»»åŠ¡
ç”Ÿæˆ1500-3000å­—çš„æ²‰æµ¸å¼å™äº‹æ–‡æœ¬ã€‚

# è¦æ±‚
1. ä½¿ç”¨ç¬¬ä¸‰äººç§°è§†è§’
2. ä½¿ç”¨æ ¼å¼æ ‡è®°ï¼šç¯å¢ƒã€ã€‘ã€å¿ƒç†\`\`ã€å¯¹è¯""ã€åˆ¤å®šã€–ã€—
3. è¯¦ç»†æå†™åŠ¨ä½œã€ç¯å¢ƒã€å¯¹è¯
4. æ˜ç¡®ä½“ç°å˜åŒ–ï¼šæ—¶é—´æµé€ã€ç‰©å“å˜åŒ–ã€çŠ¶æ€æ”¹å˜ã€ä½ç½®ç§»åŠ¨
5. **åªéœ€è¦æ–‡æœ¬ï¼Œä¸éœ€è¦JSONæ ¼å¼**

# ç¤ºä¾‹
ã€æ¸…æ™¨çš„é˜³å…‰é€è¿‡çª—æ£‚æ´’å…¥é™å®¤ã€‘ï¼Œä½ ç›˜è†è€Œåï¼Œè¿è½¬ã€Šå¼•æ°”è¯€ã€‹ã€‚\`ä¸‰æ—¥ä¸çœ ä¸ä¼‘ï¼Œä½“å†…çµæ°”ç¼“ç¼“å¢é•¿\`ã€‚

"å¸ˆå…„ï¼Œè¿™æ˜¯ç­‘åŸºä¸¹ï¼Œä½ æ‹¿å»å§ã€‚"æ—æ¸…ç’ƒé€’æ¥ä¸€ä¸ªç‰ç“¶ã€‚

ã€–ä¿®ç‚¼åˆ¤å®š:æˆåŠŸ,éª°ç‚¹:15,å±æ€§:23,æœ€ç»ˆ:38,éš¾åº¦:30ã€—

ç›´æ¥è¾“å‡ºå™äº‹æ–‡æœ¬ï¼Œä¸è¦JSONåŒ…è£…ã€‚
`.trim();
}

/**
 * æ„å»ºæ­¥éª¤2æç¤ºè¯ï¼šæ•°æ®è½¬æ¢
 */
function buildConversionPrompt(
  narrativeText: string,
  saveData: SaveData
): string {
  return `
ä½ æ˜¯æ•°æ®ç»“æ„ä¸“å®¶ï¼Œè´Ÿè´£å°†å™äº‹æ–‡æœ¬è½¬æ¢ä¸ºç²¾ç¡®çš„æ•°æ®æŒ‡ä»¤ã€‚

# å™äº‹æ–‡æœ¬
${narrativeText}

# å½“å‰å­˜æ¡£ï¼ˆå®Œæ•´æ•°æ®ï¼‰
${JSON.stringify(saveData, null, 2)}

# æ•°æ®ç»“æ„è§„èŒƒ
${DATA_STRUCTURE_DEFINITIONS}  // ä» dataStructureDefinitions.ts å¯¼å…¥

# æ“ä½œè§„åˆ™
${OPERATION_RULES}  // ä» é…’é¦†æŒ‡ä»¤æç¤º_ä¼˜åŒ–.txr æå–çš„æ ¸å¿ƒè§„åˆ™

# ä»»åŠ¡
1. åˆ†æå™äº‹æ–‡æœ¬ä¸­çš„æ‰€æœ‰å˜åŒ–
2. ç”Ÿæˆ mid_term_memoryï¼ˆ100-200å­—äº‹ä»¶æ€»ç»“ï¼‰
3. ç”Ÿæˆ tavern_commandsï¼ˆç²¾ç¡®çš„æ•°æ®æŒ‡ä»¤ï¼‰

# è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼JSONï¼‰
\`\`\`json
{
  "mid_term_memory": "ç¬¬ä¸‰äººç§°å®¢è§‚æ€»ç»“æœ¬å›åˆçš„åœ°ç‚¹ã€äººç‰©ã€äº‹ä»¶ã€å¯¹è¯ã€å†³ç­–",
  "tavern_commands": [
    {"action": "add", "key": "æ¸¸æˆæ—¶é—´.åˆ†é’Ÿ", "value": 4320},
    {"action": "set", "key": "å¢ƒç•Œ.é˜¶æ®µ", "value": "ä¸­æœŸ"}
  ]
}
\`\`\`

# ä¸¥æ ¼è¦æ±‚
1. æ–‡æœ¬æåˆ°çš„æ¯ä¸ªå˜åŒ–éƒ½å¿…é¡»æœ‰å¯¹åº”æŒ‡ä»¤
2. NPCå¢ƒç•Œåªèƒ½æ˜¯ {åç§°, é˜¶æ®µ}ï¼Œä¸¥ç¦æ·»åŠ "å½“å‰è¿›åº¦"
3. å¯¿å‘½ä¸Šé™å¿…é¡»ç”¨ addï¼Œä¸èƒ½ç”¨ set
4. ä½ç½®æ›´æ–°å¿…é¡»åŒæ—¶æ›´æ–° æè¿°+longitude+latitude
5. å¦‚æœæ–‡æœ¬æ²¡æœ‰æ˜ç¡®å˜åŒ–ï¼Œtavern_commands å¯ä»¥ä¸ºç©ºæ•°ç»„
`.trim();
}

/**
 * è°ƒç”¨AIï¼ˆç»Ÿä¸€æ¥å£ï¼‰
 */
async function callAI(prompt: string, options: {
  maxTokens: number;
  temperature: number;
}): Promise<any> {
  // è°ƒç”¨å®é™…çš„ tavernAI æ¥å£
  const { generateItemWithTavernAI } = await import('../tavernCore');
  return generateItemWithTavernAI(prompt, 'ç”Ÿæˆä¸­', false, 3, false);
}

/**
 * éªŒè¯æ•°æ®æŒ‡ä»¤
 */
function validateCommands(commands: TavernCommand[], saveData: SaveData) {
  for (const cmd of commands) {
    // æ£€æŸ¥å…³é”®é”™è¯¯
    if (cmd.key.includes('äººç‰©å…³ç³»') && cmd.key.includes('å¢ƒç•Œ')) {
      const value = cmd.value as any;
      if (value && typeof value === 'object') {
        if ('å½“å‰è¿›åº¦' in value || 'ä¸‹ä¸€çº§æ‰€éœ€' in value) {
          throw new Error(
            `NPCå¢ƒç•Œæ ¼å¼é”™è¯¯ï¼š${cmd.key}ï¼ŒNPCå¢ƒç•Œåªèƒ½æœ‰{åç§°,é˜¶æ®µ}ä¸¤ä¸ªå­—æ®µ`
          );
        }
      }
    }

    // æ£€æŸ¥å¯¿å‘½ä¸Šé™æ˜¯å¦é”™è¯¯ä½¿ç”¨ set
    if (cmd.key === 'å±æ€§.å¯¿å‘½.ä¸Šé™' && cmd.action === 'set') {
      console.warn('âš ï¸ å¯¿å‘½ä¸Šé™åº”è¯¥ä½¿ç”¨ add è€Œé setï¼Œå·²è‡ªåŠ¨ä¿®æ­£');
      cmd.action = 'add';
    }
  }
}
```

---

## ğŸ”„ æç¤ºè¯è¿ç§»

### æ—§æç¤ºè¯æ‹†åˆ†æ–¹æ¡ˆ

#### `é…’é¦†åŠ©æ‰‹.txr` â†’ æ‹†åˆ†ä¸ºä¸¤éƒ¨åˆ†

**æ­¥éª¤1ç”¨ï¼ˆå™äº‹éƒ¨åˆ†ï¼‰**ï¼š
```
- æ ¸å¿ƒèº«ä»½ä¸èŒè´£ â†’ step1_narrative.ts
- å™äº‹é£æ ¼ â†’ step1_narrative.ts
- æ ¼å¼æ ‡è®°ã€ã€‘``""ã€–ã€— â†’ step1_narrative.ts
```

**æ­¥éª¤2ç”¨ï¼ˆæ•°æ®éƒ¨åˆ†ï¼‰**ï¼š
```
- æ•°æ®é©±åŠ¨åŸåˆ™ â†’ step2_dataConversion.ts
- åŒæ­¥é“å¾‹ â†’ step2_dataConversion.ts
- ç®€åŒ–è·¯å¾„æ ¼å¼ â†’ step2_dataConversion.ts
```

#### `é…’é¦†æŒ‡ä»¤æç¤º_ä¼˜åŒ–.txr` â†’ å®Œæ•´ç§»å…¥æ­¥éª¤2

```
âœ… å…¨éƒ¨ç§»å…¥ step2_dataConversion.ts
- å¼ºåˆ¶ç»“æ„æ£€æŸ¥æ¸…å•
- JSONç»“æ„æ´ç™–
- æ“ä½œç±»å‹é€ŸæŸ¥è¡¨
- å¸¸ç”¨æ“ä½œç¤ºä¾‹
```

#### `åˆ¤å®šç³»ç»Ÿ.txr` â†’ æ­¥éª¤1ä½¿ç”¨

```
âœ… ç§»å…¥ step1_narrative.ts
- åˆ¤å®šå…¬å¼
- åˆ¤å®šæ ¼å¼ã€–...ã€—
- æˆ˜æ–—ä¼¤å®³è®¡ç®—
- çªç ´è§„åˆ™
```

### æç¤ºè¯é‡ç»„ç»“æœ

#### `step1_narrative.ts` å†…å®¹

```typescript
export const STEP1_NARRATIVE_PROMPT = `
# ä½ æ˜¯è°
ä¿®ä»™ä¸–ç•Œã€Šå¤§é“æœå¤©ã€‹çš„å™äº‹è€…

# å™äº‹é£æ ¼
- æ ¼å¼æ ‡è®°ï¼šç¯å¢ƒã€ã€‘ã€å¿ƒç†\`\`ã€å¯¹è¯""ã€åˆ¤å®šã€–ã€—
- å­—æ•°ï¼š1500-3000å­—
- è§†è§’ï¼šç¬¬ä¸‰äººç§°
- ç»†èŠ‚ï¼šç¯å¢ƒã€åŠ¨ä½œã€æƒ…ç»ªã€å¯¹è¯

# åˆ¤å®šç³»ç»Ÿ
[å®Œæ•´çš„åˆ¤å®šå…¬å¼å’Œè§„åˆ™]

# ä¸–ç•ŒèƒŒæ™¯
[æœå¤©å¤§é™†è®¾å®š]

# è¾“å‡ºæ ¼å¼
çº¯æ–‡æœ¬ï¼Œä¸éœ€è¦JSONåŒ…è£…ã€‚
`;
```

#### `step2_dataConversion.ts` å†…å®¹

```typescript
export const STEP2_CONVERSION_PROMPT = `
# ä½ æ˜¯è°
æ•°æ®ç»“æ„ä¸“å®¶

# ä»»åŠ¡
å°†å™äº‹æ–‡æœ¬è½¬æ¢ä¸ºç²¾ç¡®çš„æ•°æ®æŒ‡ä»¤

# æ•°æ®ç»“æ„è§„èŒƒ
[å®Œæ•´çš„ DATA_STRUCTURE_DEFINITIONS]

# æ“ä½œè§„åˆ™
[å®Œæ•´çš„æ“ä½œç±»å‹å’Œç¤ºä¾‹]

# ä¸¥æ ¼æ£€æŸ¥æ¸…å•
1. NPCå¢ƒç•Œåªèƒ½æ˜¯{åç§°,é˜¶æ®µ}
2. å¯¿å‘½ä¸Šé™å¿…é¡»ç”¨add
3. ä½ç½®æ›´æ–°å¿…é¡»ä¸‰ä¸ªå­—æ®µåŒæ­¥

# è¾“å‡ºæ ¼å¼
\`\`\`json
{
  "mid_term_memory": "...",
  "tavern_commands": [...]
}
\`\`\`
`;
```

---

## ğŸ¯ é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

### `MainGamePanel.vue` ä¿®æ”¹

```typescript
// åŸæœ‰æ–¹æ³•ï¼ˆä¿æŒå…¼å®¹ï¼‰
async function sendMessage_Old(userInput: string) {
  const response = await generateSimpleResponse(userInput, saveData);
  // ä¸€æ¬¡æ€§è·å¾— text + mid_term_memory + tavern_commands
}

// æ–°æ–¹æ³•ï¼ˆä¸¤æ­¥ç”Ÿæˆï¼‰
async function sendMessage_New(userInput: string) {
  // æ­¥éª¤1ï¼šç”Ÿæˆå™äº‹ï¼ˆç«‹å³æ˜¾ç¤ºç»™ç”¨æˆ·ï¼‰
  const { generateResponseTwoStep } = await import('@/utils/generators/twoStepGenerator');

  const response = await generateResponseTwoStep(
    userInput,
    saveData.value,
    {
      // å›è°ƒï¼šå™äº‹æ–‡æœ¬ç”Ÿæˆåç«‹å³æ˜¾ç¤º
      onNarrativeReady: (text) => {
        displayMessage(text);  // ç”¨æˆ·æå‰çœ‹åˆ°æ•…äº‹
        showLoading('æ­£åœ¨æ›´æ–°æ•°æ®...');  // æ˜¾ç¤ºæ­¥éª¤2è¿›åº¦
      }
    }
  );

  // æ­¥éª¤2å®Œæˆåï¼Œåº”ç”¨æ•°æ®å˜æ›´
  await applyCommands(response.tavern_commands);
  hideLoading();
}

// é…ç½®å¼€å…³
const useTwoStepGeneration = ref(true);  // é»˜è®¤å¯ç”¨

async function sendMessage(userInput: string) {
  if (useTwoStepGeneration.value) {
    return sendMessage_New(userInput);
  } else {
    return sendMessage_Old(userInput);
  }
}
```

### ç”¨æˆ·ä½“éªŒä¼˜åŒ–

```typescript
// æµç¨‹æ—¶é—´çº¿
0s   ç”¨æˆ·å‘é€æŒ‡ä»¤
0.5s AIå¼€å§‹ç”Ÿæˆå™äº‹
3s   å™äº‹æ–‡æœ¬å®Œæˆ â† ç«‹å³æ˜¾ç¤ºç»™ç”¨æˆ·
3.5s AIå¼€å§‹ç”Ÿæˆæ•°æ®æŒ‡ä»¤
5s   æ•°æ®æŒ‡ä»¤å®Œæˆ â† æ›´æ–°ç•Œé¢æ•°æ®
```

**ä¼˜åŠ¿**ï¼š
- ç”¨æˆ·åœ¨3ç§’å°±èƒ½çœ‹åˆ°æ•…äº‹ï¼ˆåŸæœ¬è¦5ç§’ï¼‰
- å³ä½¿æ­¥éª¤2å¤±è´¥ï¼Œç”¨æˆ·ä¹Ÿå·²ç»çœ‹åˆ°äº†æ•…äº‹
- å¯ä»¥åœ¨ç•Œé¢ä¸Šæ˜¾ç¤º"æ­£åœ¨æ›´æ–°æ•°æ®..."ï¼Œç”¨æˆ·çŸ¥é“ç³»ç»Ÿåœ¨å·¥ä½œ

---

## ğŸ“Š å¯¹æ¯”åˆ†æ

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¸€æ­¥ç”Ÿæˆ | ä¸¤æ­¥ç”Ÿæˆ | å˜åŒ– |
|------|---------|---------|------|
| æ€»è€—æ—¶ | 8-12ç§’ | 10-15ç§’ | +20% |
| ç”¨æˆ·ç­‰å¾…æ—¶é—´ | 8-12ç§’ | 3-5ç§’(æ–‡æœ¬) | -60% |
| Tokenæ¶ˆè€— | 8000 | 3000+5000 | æŒå¹³ |
| æ ¼å¼é”™è¯¯ç‡ | 15-20% | <3% | -85% |
| æ–‡æœ¬è´¨é‡ | ä¸­ç­‰ | é«˜ | +40% |

### æˆæœ¬åˆ†æ

```
å•æ¬¡å¯¹è¯æˆæœ¬ï¼ˆä»¥GPT-4ä¸ºä¾‹ï¼‰ï¼š
ä¸€æ­¥ç”Ÿæˆï¼š
  è¾“å…¥ï¼š8000 tokens Ã— $0.03/1K = $0.24
  è¾“å‡ºï¼š2000 tokens Ã— $0.06/1K = $0.12
  æ€»è®¡ï¼š$0.36

ä¸¤æ­¥ç”Ÿæˆï¼š
  æ­¥éª¤1ï¼š
    è¾“å…¥ï¼š3000 tokens Ã— $0.03/1K = $0.09
    è¾“å‡ºï¼š2000 tokens Ã— $0.06/1K = $0.12
  æ­¥éª¤2ï¼š
    è¾“å…¥ï¼š5000 tokens Ã— $0.03/1K = $0.15
    è¾“å‡ºï¼š500 tokens Ã— $0.06/1K = $0.03
  æ€»è®¡ï¼š$0.39

æˆæœ¬å¢åŠ ï¼š8%ï¼ˆä½†è´¨é‡å¤§å¹…æå‡ï¼‰
```

### ä¼˜åŒ–å»ºè®®

1. **æ­¥éª¤1ä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹**
   - å¦‚ GPT-3.5 Turboï¼ˆæˆæœ¬ -90%ï¼‰
   - å™äº‹è´¨é‡ç•¥é™ä½†å¯æ¥å—

2. **æ­¥éª¤2ç¼“å­˜å¸¸è§æ¨¡å¼**
   - ä¿®ç‚¼ã€å¯¹è¯ç­‰å¸¸è§æ“ä½œ
   - å¯ä»¥ç”¨è§„åˆ™å¼•æ“ä»£æ›¿éƒ¨åˆ†AIè°ƒç”¨

3. **æ™ºèƒ½é€‰æ‹©æ¨¡å¼**
   - ç®€å•æ“ä½œï¼šä¸€æ­¥ç”Ÿæˆ
   - å¤æ‚å‰§æƒ…ï¼šä¸¤æ­¥ç”Ÿæˆ

---

## ğŸš€ å®æ–½è®¡åˆ’

### ç¬¬1å¤©ï¼šå‡†å¤‡å·¥ä½œ
- [ ] åˆ›å»º `twoStepGenerator.ts` æ–‡ä»¶
- [ ] æ‹†åˆ†æç¤ºè¯åˆ° `step1_narrative.ts` å’Œ `step2_dataConversion.ts`
- [ ] ç¼–å†™ `validateCommands()` éªŒè¯å‡½æ•°

### ç¬¬2å¤©ï¼šå¹¶è¡Œæµ‹è¯•
- [ ] åœ¨ MainGamePanel.vue ä¸­æ·»åŠ ä¸¤æ­¥ç”Ÿæˆå‡½æ•°
- [ ] æ·»åŠ é…ç½®å¼€å…³ `useTwoStepGeneration`
- [ ] æµ‹è¯•10ä¸ªåœºæ™¯ï¼Œå¯¹æ¯”æˆåŠŸç‡

### ç¬¬3å¤©ï¼šä¼˜åŒ–è°ƒæ•´
- [ ] æ ¹æ®æµ‹è¯•ç»“æœè°ƒæ•´æç¤ºè¯
- [ ] ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼ˆè¿›åº¦æç¤ºï¼‰
- [ ] æ·»åŠ é”™è¯¯é‡è¯•é€»è¾‘

### ç¬¬4å¤©ï¼šç°åº¦å‘å¸ƒ
- [ ] 50%ç”¨æˆ·ä½¿ç”¨ä¸¤æ­¥ç”Ÿæˆ
- [ ] æ”¶é›†é”™è¯¯æ—¥å¿—å’Œç”¨æˆ·åé¦ˆ
- [ ] å¯¹æ¯”æ•°æ®è´¨é‡

### ç¬¬5å¤©ï¼šå…¨é‡åˆ‡æ¢
- [ ] 100%åˆ‡æ¢åˆ°ä¸¤æ­¥ç”Ÿæˆ
- [ ] ç§»é™¤æ—§ä»£ç ï¼ˆå¯é€‰ï¼‰
- [ ] æ›´æ–°æ–‡æ¡£

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1ï¼šæ­¥éª¤1ç”Ÿæˆçš„æ–‡æœ¬ä¸å¤Ÿè¯¦ç»†æ€ä¹ˆåŠï¼Ÿ
**A**ï¼šè°ƒæ•´ maxTokens å’Œ temperature å‚æ•°ï¼Œæˆ–åœ¨æç¤ºè¯ä¸­å¢åŠ "è¯¦ç»†æå†™"çš„è¦æ±‚ã€‚

### Q2ï¼šæ­¥éª¤2è¯†åˆ«ä¸å‡ºæ–‡æœ¬ä¸­çš„å˜åŒ–ï¼Ÿ
**A**ï¼šåœ¨æ­¥éª¤1çš„æç¤ºè¯ä¸­å¼ºè°ƒ"æ˜ç¡®ä½“ç°å˜åŒ–"ï¼Œä¾‹å¦‚æ˜ç¡®å†™å‡º"ä¸‰å¤©å"è€Œé"ä¸ä¹…ä¹‹å"ã€‚

### Q3ï¼šä¸¤æ­¥ç”Ÿæˆå¤ªæ…¢ï¼Œç”¨æˆ·ä½“éªŒå·®ï¼Ÿ
**A**ï¼šä½¿ç”¨ `onNarrativeReady` å›è°ƒï¼Œæ­¥éª¤1å®Œæˆåç«‹å³æ˜¾ç¤ºæ–‡æœ¬ç»™ç”¨æˆ·ã€‚

### Q4ï¼šå¦‚ä½•å›é€€åˆ°ä¸€æ­¥ç”Ÿæˆï¼Ÿ
**A**ï¼šè®¾ç½® `useTwoStepGeneration = false` å³å¯ï¼Œæ—§ä»£ç å®Œå…¨ä¿ç•™ã€‚

---

## ğŸ“ é™„å½•ï¼šå®Œæ•´ä»£ç æ¨¡æ¿

è§ç‹¬ç«‹æ–‡ä»¶ï¼š
- `src/utils/generators/twoStepGenerator.ts`
- `src/utils/prompts/step1_narrative.ts`
- `src/utils/prompts/step2_dataConversion.ts`
- `src/utils/validators/commandValidator.ts`
