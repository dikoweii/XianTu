# 脱离酒馆依赖的本地化设计方案

## 1. 当前酒馆依赖分析

### 1.1 核心依赖模块
- **src/utils/tavern.ts** - 酒馆基础API包装器
- **src/utils/tavernAI.ts** - 酒馆AI生成器
- **src/utils/AIGameMaster.ts** - AI游戏主控
- **webpack/TavernLiveReloadPlugin.js** - 开发环境热重载

### 1.2 功能依赖点
1. **世界书管理** - 通过酒馆Lorebook API管理世界法则条目
2. **变量系统** - 使用酒馆全局/局部变量存储游戏状态
3. **AI生成** - 依赖酒馆的generateRaw API进行内容生成

## 2. 本地世界书系统设计

### 2.1 数据结构设计

```typescript
// 世界书条目接口
interface LorebookEntry {
  id: string;                    // 唯一标识符
  title: string;                 // 条目标题
  content: string;               // 详细内容
  keywords: string[];            // 触发关键词
  category: EntryCategory;       // 条目分类
  enabled: boolean;              // 是否启用
  priority: number;              // 优先级 (0-100)
  position: 'before_character' | 'after_character' | 'top'; // 在对话中的位置
  createdAt: Date;              // 创建时间
  updatedAt: Date;              // 更新时间
}

// 条目分类枚举
enum EntryCategory {
  WORLD_SETTING = 'world_setting',      // 世界设定
  CHARACTER_INFO = 'character_info',    // 角色信息
  CULTIVATION_SYSTEM = 'cultivation',   // 修炼体系
  TREASURE_SYSTEM = 'treasure',         // 法宝系统
  LOCATION = 'location',                // 地点信息
  ORGANIZATION = 'organization',        // 组织势力
  CUSTOM = 'custom'                     // 自定义
}

// 世界书数据库接口
interface LocalLorebook {
  id: string;                    // 世界书唯一ID
  name: string;                  // 世界书名称
  description: string;           // 描述
  entries: LorebookEntry[];      // 条目列表
  metadata: {
    version: string;             // 版本号
    author: string;              // 作者
    lastModified: Date;          // 最后修改时间
  };
}
```

### 2.2 核心功能模块

#### 2.2.1 世界书管理器 (LorebookManager)

```typescript
class LocalLorebookManager {
  private lorebooks: Map<string, LocalLorebook>;
  private activeLorebookId: string | null;

  // 基础CRUD操作
  createLorebook(name: string, description?: string): LocalLorebook;
  loadLorebook(id: string): LocalLorebook | null;
  saveLorebook(lorebook: LocalLorebook): Promise<void>;
  deleteLorebook(id: string): Promise<void>;
  
  // 条目管理
  addEntry(lorebookId: string, entry: Omit<LorebookEntry, 'id' | 'createdAt' | 'updatedAt'>): LorebookEntry;
  updateEntry(lorebookId: string, entryId: string, updates: Partial<LorebookEntry>): void;
  deleteEntry(lorebookId: string, entryId: string): void;
  
  // 查询和搜索
  searchEntries(lorebookId: string, query: string): LorebookEntry[];
  getEntriesByCategory(lorebookId: string, category: EntryCategory): LorebookEntry[];
  findTriggeredEntries(lorebookId: string, text: string): LorebookEntry[];
  
  // 导入导出
  exportLorebook(lorebookId: string): string; // JSON格式
  importLorebook(data: string): LocalLorebook;
  importFromText(filePath: string, category?: EntryCategory): LorebookEntry[];
}
```

#### 2.2.2 关键词触发系统 (KeywordTrigger)

```typescript
class KeywordTriggerSystem {
  // 检查文本中是否包含触发关键词
  findMatchingKeywords(text: string, entries: LorebookEntry[]): {
    entry: LorebookEntry;
    matchedKeywords: string[];
  }[];
  
  // 按优先级排序触发的条目
  sortByPriority(triggeredEntries: LorebookEntry[]): LorebookEntry[];
  
  // 构建用于AI的世界书上下文
  buildLorebookContext(triggeredEntries: LorebookEntry[]): string;
}
```

#### 2.2.3 存储适配器 (StorageAdapter)

```typescript
interface StorageAdapter {
  save(key: string, data: any): Promise<void>;
  load(key: string): Promise<any>;
  delete(key: string): Promise<void>;
  list(prefix?: string): Promise<string[]>;
}

// 本地存储实现
class LocalStorageAdapter implements StorageAdapter {
  // 使用localStorage或IndexedDB
}

// 文件系统实现 (Electron环境)
class FileSystemAdapter implements StorageAdapter {
  // 使用文件系统存储
}
```

### 2.3 预设世界书模板

基于现有设定文档，创建预设模板：

```typescript
const PRESET_TEMPLATES = {
  // 基础修仙世界设定
  CULTIVATION_WORLD: {
    name: '修仙世界基础设定',
    categories: [
      {
        category: EntryCategory.CULTIVATION_SYSTEM,
        entries: [
          {
            title: '功法系统',
            keywords: ['功法', '修炼', '境界'],
            content: '功法分为凡品、奇珍、极品、绝品、通天五个品质...'
          },
          {
            title: '法宝系统', 
            keywords: ['法宝', '符器', '灵宝'],
            content: '法宝分为符器、法器、通宝、灵宝、至宝五个等级...'
          }
        ]
      },
      {
        category: EntryCategory.CHARACTER_INFO,
        entries: [
          {
            title: 'NPC角色指导原则',
            keywords: ['NPC', '角色', '人物'],
            content: '每个角色具有核心驱动力，避免刻板印象...'
          }
        ]
      }
    ]
  }
};
```

### 2.4 文件结构

```
src/
├── services/
│   ├── lorebook/
│   │   ├── LorebookManager.ts          // 主管理器
│   │   ├── KeywordTrigger.ts           // 关键词触发
│   │   ├── StorageAdapter.ts           // 存储适配器
│   │   └── PresetTemplates.ts          // 预设模板
│   └── localData.ts                    // 本地数据管理 (现有)
├── types/
│   └── Lorebook.d.ts                   // 类型定义
└── utils/
    └── lorebookUtils.ts                // 工具函数
```

## 3. 本地变量系统设计

### 3.1 变量作用域设计

```typescript
// 变量作用域类型
type VariableScope = 'global' | 'chat' | 'character' | 'session';

// 变量存储接口
interface LocalVariable {
  key: string;
  value: any;
  scope: VariableScope;
  type: 'string' | 'number' | 'boolean' | 'object' | 'array';
  metadata?: {
    description?: string;
    lastModified: Date;
    source: 'user' | 'ai' | 'system';
  };
}

// 变量管理器
class LocalVariableManager {
  private variables: Map<string, Map<string, LocalVariable>>;
  
  // 基础操作
  set(scope: VariableScope, key: string, value: any): void;
  get(scope: VariableScope, key: string): any;
  delete(scope: VariableScope, key: string): void;
  has(scope: VariableScope, key: string): boolean;
  
  // 批量操作
  setMultiple(scope: VariableScope, data: Record<string, any>): void;
  getAll(scope: VariableScope): Record<string, any>;
  clear(scope: VariableScope): void;
  
  // 数组操作
  push(scope: VariableScope, key: string, value: any): void;
  pull(scope: VariableScope, key: string, value: any): void;
  
  // 数值操作
  add(scope: VariableScope, key: string, value: number): void;
  
  // 导入导出
  export(scope?: VariableScope): string;
  import(data: string, scope: VariableScope): void;
}
```

### 3.2 持久化策略

```typescript
interface VariablePersistence {
  // 不同作用域的持久化策略
  global: 'localStorage',      // 全局变量用localStorage
  character: 'indexedDB',      // 角色变量用IndexedDB
  chat: 'sessionStorage',      // 对话变量用sessionStorage
  session: 'memory'            // 会话变量仅内存
}
```

## 4. 可配置AI API系统设计

### 4.1 AI提供商接口

```typescript
// AI提供商基础接口
interface AIProvider {
  name: string;
  type: 'openai' | 'anthropic' | 'local' | 'custom';
  
  // 生成方法
  generate(request: AIGenerationRequest): Promise<AIGenerationResponse>;
  
  // 配置验证
  validateConfig(config: AIProviderConfig): Promise<boolean>;
}

// AI生成请求
interface AIGenerationRequest {
  prompt: string;
  systemPrompt?: string;
  temperature?: number;
  maxTokens?: number;
  model?: string;
}

// AI生成响应
interface AIGenerationResponse {
  text: string;
  usage?: {
    promptTokens: number;
    completionTokens: number;
    totalTokens: number;
  };
  metadata?: any;
}
```

### 4.2 配置管理

```typescript
// AI配置接口
interface AIProviderConfig {
  provider: string;
  apiKey?: string;
  apiUrl?: string;
  model: string;
  defaultParams: {
    temperature: number;
    maxTokens: number;
  };
  headers?: Record<string, string>;
}

// 配置管理器
class AIConfigManager {
  private configs: Map<string, AIProviderConfig>;
  
  // 配置CRUD
  addProvider(id: string, config: AIProviderConfig): void;
  getProvider(id: string): AIProviderConfig | null;
  updateProvider(id: string, updates: Partial<AIProviderConfig>): void;
  deleteProvider(id: string): void;
  
  // 激活管理
  setActiveProvider(id: string): void;
  getActiveProvider(): AIProviderConfig | null;
  
  // 验证和测试
  testProvider(id: string): Promise<boolean>;
  validateAllProviders(): Promise<Record<string, boolean>>;
}
```

### 4.3 具体实现类

```typescript
// OpenAI兼容提供商
class OpenAIProvider implements AIProvider {
  name = 'OpenAI';
  type = 'openai' as const;
  
  async generate(request: AIGenerationRequest): Promise<AIGenerationResponse> {
    // 实现OpenAI API调用
  }
}

// Anthropic Claude提供商
class AnthropicProvider implements AIProvider {
  name = 'Anthropic';
  type = 'anthropic' as const;
  
  async generate(request: AIGenerationRequest): Promise<AIGenerationResponse> {
    // 实现Anthropic API调用
  }
}

// 本地AI提供商 (如Ollama)
class LocalAIProvider implements AIProvider {
  name = 'Local AI';
  type = 'local' as const;
  
  async generate(request: AIGenerationRequest): Promise<AIGenerationResponse> {
    // 实现本地AI调用
  }
}

// 自定义API提供商
class CustomAPIProvider implements AIProvider {
  name = 'Custom API';
  type = 'custom' as const;
  
  async generate(request: AIGenerationRequest): Promise<AIGenerationResponse> {
    // 实现自定义API调用
  }
}
```

## 5. 迁移策略

### 5.1 渐进式替换

1. **第一阶段：并行实现**
   - 保持现有酒馆集成
   - 实现本地系统作为可选功能
   - 添加开关控制使用哪套系统

2. **第二阶段：功能迁移**
   - 逐步将功能从酒馆迁移到本地
   - 保留酒馆接口作为备用
   - 数据迁移工具

3. **第三阶段：完全独立**
   - 移除酒馆依赖
   - 清理相关代码
   - 更新文档

### 5.2 数据迁移

```typescript
// 迁移工具接口
interface MigrationTool {
  // 从酒馆导出数据
  exportFromTavern(): Promise<{
    variables: Record<string, any>;
    lorebook: any[];
  }>;
  
  // 转换为本地格式
  convertToLocal(tavernData: any): {
    variables: LocalVariable[];
    lorebook: LocalLorebook;
  };
  
  // 导入到本地系统
  importToLocal(localData: any): Promise<void>;
}
```

## 6. 配置文件设计

### 6.1 本地配置文件

```typescript
// config/local-ai.json
interface LocalConfig {
  ai: {
    activeProvider: string;
    providers: Record<string, AIProviderConfig>;
  };
  lorebook: {
    activeLorebookId: string;
    autoTrigger: boolean;
    maxTriggeredEntries: number;
  };
  variables: {
    persistenceStrategy: VariablePersistence;
    autoSave: boolean;
    backupInterval: number; // minutes
  };
  features: {
    useLocalLorebook: boolean;
    useLocalVariables: boolean;
    useLocalAI: boolean;
  };
}
```

### 6.2 用户界面设计

```typescript
// 设置界面组件结构
components/
├── settings/
│   ├── AIProviderSettings.vue        // AI提供商配置
│   ├── LorebookSettings.vue          // 世界书设置
│   ├── VariableSettings.vue          // 变量管理
│   └── MigrationWizard.vue           // 迁移向导
```

这个设计方案提供了完整的本地化替代方案，可以逐步替换酒馆的所有核心功能，同时保持系统的灵活性和可扩展性。